<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidsregistrering</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tidsreg">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png"> 
    <meta name="theme-color" content="#4f46e5">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative; /* For version number positioning */
        }
        .version-number {
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 0.7rem;
            color: #9ca3af; /* Gray-400 */
        }
        .form-input, .form-select, .form-textarea, .form-checkbox {
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25);
        }
        .form-checkbox {
             width: auto; padding: 0; margin-right: 0.5rem; margin-left:0.25rem; border-radius: 0.25rem; color: #4f46e5;
        }
        .form-checkbox:focus {
            outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25); border-color: #4f46e5;
        }
        .form-select:disabled, .form-input:disabled {
            background-color: #e5e7eb; cursor: not-allowed; opacity: 0.7;
        }
        .form-select option.time-slot-booked {
            color: red !important;
        }
        .form-select option.time-slot-available {
            color: green !important;
        }
         .form-select option.time-slot-blocked {
            color: #b91c1c !important;
        }


        .btn {
            padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 500;
            transition: background-color 0.15s ease-in-out; cursor: pointer; text-align: center;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #15803d; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; }
        .btn-info { background-color: #3b82f6; color: white; }
        .btn-info:hover:not(:disabled) { background-color: #2563eb; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        th, td { border: 1px solid #e5e7eb; padding: 0.4rem; text-align: left; font-size: 0.75rem; vertical-align: top; }
        th { background-color: #f9fafb; font-weight: 600; white-space: nowrap; }
        td .fa-pencil, td .fa-trash-can { cursor: pointer; margin-right: 8px; }
        
        .week-header-row, .day-header-row { cursor: pointer; user-select: none; }
        .week-header-row td, .day-header-row td { background-color: #f3f4f6; font-weight: bold; }
        .day-header-row td:first-child { padding-left: 1.5rem; } 
        .entry-row td:first-child { padding-left: 2.5rem; } 

        .toggle-icon { margin-right: 0.5em; transition: transform 0.2s; display: inline-block; }
        .toggle-icon.expanded { transform: rotate(90deg); }

        .error-message { color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; min-height: 1.25rem; }
        .quick-entry-section { background-color: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border: 1px solid #e5e7eb; }
        .quick-entry-section .grid { align-items: end; }
        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 250px; background-color: #555; color: #fff; text-align: left;
            border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%;
            margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; font-weight: normal;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 0.5rem;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        }
        .modal-content h3 { margin-top: 0; }
        .modal-content label { display: block; margin-bottom: 0.5rem; }
        .modal-close-btn {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
        }
        .modal-close-btn:hover, .modal-close-btn:focus {
            color: black; text-decoration: none; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-700">Tidsregistrering</h1>
            <button id="openSettingsModalBtn" class="btn btn-secondary px-3 py-2"><i class="fas fa-cog"></i></button>
        </div>

        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <span class="modal-close-btn" id="closeSettingsModalBtn">&times;</span>
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Indstillinger</h3>
                <form id="settingsForm" class="space-y-4">
                    <div>
                        <label for="employeeName" class="block text-sm font-medium text-gray-700">Medarbejder Navn:</label>
                        <input type="text" id="employeeName" name="employeeName" class="form-input mt-1" placeholder="Dit fulde navn" required>
                    </div>
                    <div>
                        <label for="siteLocationsSettings" class="block text-sm font-medium text-gray-700">
                            Byggepladser & Placeringer
                            <span class="tooltip text-gray-500">(?)
                                <span class="tooltiptext">Indtast én byggeplads pr. linje.<br>Format: <code>Byggeplads Navn: Placering 1, Placering 2</code><br>Hvis en byggeplads ikke har specifikke placeringer, skriv kun navnet efterfulgt af et kolon (f.eks. <code>Kontor:</code>).</span>
                            </span>
                        </label>
                        <textarea id="siteLocationsSettings" name="siteLocationsSettings" rows="5" class="form-textarea mt-1" placeholder="Eksempel:&#10;Hovedkontor: Mødelokale A, Kantine&#10;Projekt Alpha: Bygning 1, Bygning 2 - Etage 3&#10;Værksted:"></textarea>
                    </div>
                    <div class="mt-6">
                         <button type="button" id="exportCsvBtnModal" class="btn btn-info w-full mb-2">
                            Eksporter til CSV
                        </button>
                    </div>
                     <button type="submit" class="btn btn-success w-full">Gem Indstillinger</button>
                    <div id="settingsStatus" class="text-sm mt-2"></div>
                </form>
            </div>
        </div>


        <div class="quick-entry-section">
             <h3 class="text-lg font-semibold mb-3 text-gray-600">Hurtig Registrering (Hele Dagen)</h3>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div>
                     <label for="quickEntryDate" class="block text-sm font-medium text-gray-700">Vælg Dato:</label>
                     <input type="date" id="quickEntryDate" name="quickEntryDate" class="form-input mt-1" required>
                 </div>
                 <div class="flex space-x-2">
                     <button type="button" id="registerSickBtn" class="btn btn-warning w-full">Registrer Syg</button>
                     <button type="button" id="registerFreeBtn" class="btn btn-info w-full">Registrer Fri/Ferie</button>
                 </div>
                 <div id="quickEntryError" class="error-message md:col-span-3"></div>
             </div>
        </div>
        <div id="freeDayTypeModal" class="modal">
            <div class="modal-content">
                <span class="modal-close-btn" id="closeFreeDayTypeModalBtn">&times;</span>
                <h3 class="text-lg font-semibold mb-3">Vælg Type Fravær</h3>
                <div class="space-y-3">
                    <button id="registerFerieHeleDageBtn" class="btn btn-primary w-full">Ferie (Hele Dage)</button>
                    <div>
                        <label for="friTimerInput" class="block text-sm font-medium text-gray-700">Fri (Antal Timer):</label>
                        <input type="number" id="friTimerInput" min="0.5" step="0.5" class="form-input mt-1" placeholder="F.eks. 3.5">
                        <button id="registerFriTimerBtn" class="btn btn-primary w-full mt-2">Registrer Fri (Timer)</button>
                    </div>
                </div>
                <div id="freeDayTypeError" class="error-message mt-3"></div>
            </div>
        </div>


        <form id="timeRegistrationForm" class="space-y-4 mt-6">
             <h3 class="text-lg font-semibold mb-3 text-gray-600" id="formHeading">Normal Registrering</h3>
            <input type="hidden" id="editingEntryId" value="">
            <div>
                <label for="dato" class="block text-sm font-medium text-gray-700">Dato:</label>
                <input type="date" id="dato" name="dato" class="form-input mt-1" required>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="byggeplads" class="block text-sm font-medium text-gray-700">Byggeplads:</label>
                    <select id="byggeplads" name="byggeplads" class="form-select mt-1">
                        <option value="">-- Vælg Byggeplads --</option>
                    </select>
                </div>
                 <div>
                    <label for="placering" class="block text-sm font-medium text-gray-700">Placering (på byggeplads):</label>
                    <select id="placering" name="placering" class="form-select mt-1" disabled>
                         <option value="">-- Vælg Byggeplads Først --</option>
                    </select>
                </div>
            </div>
             <div>
                <label for="opgave" class="block text-sm font-medium text-gray-700">Opgave:</label>
                <input type="text" id="opgave" name="opgave" class="form-input mt-1" placeholder="F.eks. Montering af vinduer, Oprydning">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="startTid" class="block text-sm font-medium text-gray-700">Starttid:</label>
                    <select id="startTid" name="startTid" class="form-select mt-1" required></select>
                </div>
                <div>
                    <label for="slutTid" class="block text-sm font-medium text-gray-700">Sluttid:</label>
                    <select id="slutTid" name="slutTid" class="form-select mt-1" required></select>
                </div>
            </div>

             <div class="mt-2 space-y-2 md:space-y-0 md:flex md:items-center md:space-x-4">
                 <div class="flex items-center">
                     <input type="checkbox" id="pause9" name="pause9" class="form-checkbox h-4 w-4">
                     <label for="pause9" class="ml-1 text-sm font-medium text-gray-700">Pause kl. 9 (30 min)</label>
                 </div>
                 <div class="flex items-center">
                     <input type="checkbox" id="pause12" name="pause12" class="form-checkbox h-4 w-4">
                     <label for="pause12" class="ml-1 text-sm font-medium text-gray-700">Pause kl. 12 (30 min)</label>
                 </div>
                 <div class="flex items-center">
                     <input type="checkbox" id="ekstraarbejde" name="ekstraarbejde" class="form-checkbox h-4 w-4">
                     <label for="ekstraarbejde" class="ml-1 text-sm font-medium text-gray-700">Ekstraarbejde</label>
                 </div>
             </div>

            <div>
                <label for="materialer" class="block text-sm font-medium text-gray-700">Materialeforbrug:</label>
                <textarea id="materialer" name="materialer" rows="2" class="form-textarea mt-1" placeholder="F.eks. 10m kabel, 5 skruer..."></textarea>
            </div>

            <div>
                <label for="beskrivelse" class="block text-sm font-medium text-gray-700">Evt. Bemærkninger:</label>
                <textarea id="beskrivelse" name="beskrivelse" rows="2" class="form-textarea mt-1" placeholder="Yderligere detaljer..."></textarea>
            </div>

            <div id="formError" class="error-message"></div>

            <div class="flex space-x-2">
                <button type="submit" id="submitBtn" class="btn btn-primary w-full">Tilføj Post</button>
                <button type="button" id="cancelEditBtn" class="btn btn-secondary w-full" style="display:none;">Annuller Redigering</button>
            </div>
        </form>

        <div id="statusMessage" class="mt-4"></div> 
        <div id="googleSheetStatus" class="mt-4"></div> 
        
        <h2 class="text-xl font-semibold mt-8 mb-4 text-gray-700">Registrerede Timer</h2>
        <div class="overflow-x-auto">
            <table id="entriesTable">
                <thead>
                    <tr>
                        <th>Dato</th>
                        <th>Uge</th>
                        <th>Dag</th>
                        <th>Byggeplads</th>
                        <th>Placering</th>
                        <th>Opgave</th>
                        <th>Start</th>
                        <th>Slut</th>
                        <th>Pauser</th>
                        <th>Timer</th>
                        <th>Ekstra</th>
                        <th>Materialer</th>
                        <th>Bemærk.</th>
                        <th>Handling</th>
                    </tr>
                </thead>
                <tbody id="entriesBody"></tbody>
            </table>
        </div>
        <div id="noEntriesMessage" class="text-gray-500 mt-4 text-center" style="display: none;">Ingen registreringer endnu.</div>

        <div class="mt-6 flex space-x-2">
            <button id="sendToGoogleSheetsBtn" class="btn btn-success w-full"> 
                Send til Google Sheets
            </button>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">Sender alle nuværende registreringer. Sørg for at medarbejdernavn er gemt.</p>
        
        <div class="version-number">v1.2</div> 
    </div>

    <div id="csvExportModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeCsvExportModalBtn">&times;</span>
            <h3 class="text-lg font-semibold mb-3">Vælg Filtre for CSV Eksport</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Vælg Uger (alle hvis ingen valgt):</label>
                    <div id="csvWeekCheckboxesContainer" class="max-h-40 overflow-y-auto border p-2 rounded">
                        </div>
                </div>
                <div>
                    <label for="csvByggepladsSelect" class="block text-sm font-medium text-gray-700">Vælg Byggeplads (alle hvis ingen valgt):</label>
                    <select id="csvByggepladsSelect" class="form-select mt-1">
                        <option value="">-- Alle Byggepladser --</option>
                        </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancelCsvExportBtn" class="btn btn-secondary">Annuller</button>
                <button id="confirmCsvExportBtn" class="btn btn-primary">Eksporter CSV</button>
            </div>
             <div id="csvExportStatus" class="text-sm mt-2"></div>
        </div>
    </div>


    <script>
        // --- Globale Variabler ---
        const settingsModal = document.getElementById('settingsModal');
        const openSettingsModalBtn = document.getElementById('openSettingsModalBtn');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
        
        const settingsForm = document.getElementById('settingsForm');
        const timeRegistrationForm = document.getElementById('timeRegistrationForm');
        const formHeading = document.getElementById('formHeading');
        const editingEntryIdInput = document.getElementById('editingEntryId');
        const submitBtn = document.getElementById('submitBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        const startTidSelect = document.getElementById('startTid');
        const slutTidSelect = document.getElementById('slutTid');
        const entriesBody = document.getElementById('entriesBody');
        const formError = document.getElementById('formError');
        const settingsStatus = document.getElementById('settingsStatus');
        const statusMessage = document.getElementById('statusMessage'); 
        const googleSheetStatus = document.getElementById('googleSheetStatus');
        const noEntriesMessage = document.getElementById('noEntriesMessage');
        const entriesTable = document.getElementById('entriesTable');
        const sendToGoogleSheetsBtn = document.getElementById('sendToGoogleSheetsBtn'); 
        const exportCsvBtnModal = document.getElementById('exportCsvBtnModal');  
        
        const csvExportModal = document.getElementById('csvExportModal'); 
        const closeCsvExportModalBtn = document.getElementById('closeCsvExportModalBtn');
        const csvWeekCheckboxesContainer = document.getElementById('csvWeekCheckboxesContainer');
        const csvByggepladsSelect = document.getElementById('csvByggepladsSelect');
        const cancelCsvExportBtn = document.getElementById('cancelCsvExportBtn');
        const confirmCsvExportBtn = document.getElementById('confirmCsvExportBtn');
        const csvExportStatus = document.getElementById('csvExportStatus');


        const quickEntryDateInput = document.getElementById('quickEntryDate');
        const registerSickBtn = document.getElementById('registerSickBtn');
        const registerFreeBtn = document.getElementById('registerFreeBtn'); 
        const quickEntryError = document.getElementById('quickEntryError');

        const freeDayTypeModal = document.getElementById('freeDayTypeModal');
        const closeFreeDayTypeModalBtn = document.getElementById('closeFreeDayTypeModalBtn');
        const registerFerieHeleDageBtn = document.getElementById('registerFerieHeleDageBtn');
        const friTimerInput = document.getElementById('friTimerInput');
        const registerFriTimerBtn = document.getElementById('registerFriTimerBtn');
        const freeDayTypeError = document.getElementById('freeDayTypeError');

        const employeeNameInput = document.getElementById('employeeName');
        const siteLocationsSettingsTextarea = document.getElementById('siteLocationsSettings');
        const datoInput = document.getElementById('dato');
        const byggepladsSelect = document.getElementById('byggeplads');
        const placeringSelect = document.getElementById('placering');
        const opgaveInput = document.getElementById('opgave');
        const pause9Checkbox = document.getElementById('pause9');
        const pause12Checkbox = document.getElementById('pause12');
        const ekstraarbejdeCheckbox = document.getElementById('ekstraarbejde');
        const materialerInput = document.getElementById('materialer');
        const beskrivelseInput = document.getElementById('beskrivelse');


        let weeklyEntries = [];
        let settings = { siteLocations: [] }; 
        const standardByggepladsOptionsForForm = ["Andet"]; 
        let lastSelectedByggeplads = '';
        let lastSelectedPlacering = '';
        let currentlyEditingId = null;

        // !!! VIGTIGT: Indsæt din Google Apps Script Web App URL her !!!
        const SCRIPT_URL = "ERSTAT_MED_DIN_GOOGLE_APPS_SCRIPT_WEB_APP_URL";


        // --- Indstillinger Funktioner ---
        function parseSiteLocations(text) {
            const lines = text.trim().split('\n');
            const siteData = [];
            lines.forEach(line => {
                const parts = line.split(':');
                const siteName = parts[0]?.trim();
                if (siteName) {
                    const locationsRaw = parts[1]?.trim() || '';
                    const locations = locationsRaw ? locationsRaw.split(',').map(loc => loc.trim()).filter(loc => loc) : [];
                    siteData.push({ site: siteName, locations: locations });
                }
            });
            return siteData;
        }

        function saveSettings(event) {
            event.preventDefault();
            const rawSiteLocationsText = siteLocationsSettingsTextarea.value;
            settings = {
                employeeName: employeeNameInput.value.trim(),
                siteLocationsRaw: rawSiteLocationsText,
                siteLocations: parseSiteLocations(rawSiteLocationsText)
            };
            if (!settings.employeeName) { 
                 settingsStatus.textContent = 'Udfyld venligst medarbejdernavn.';
                 settingsStatus.className = 'text-sm mt-2 text-red-600'; return;
            }
            localStorage.setItem('timeRegSettings', JSON.stringify(settings));
            settingsStatus.textContent = 'Indstillinger gemt!';
            settingsStatus.className = 'text-sm mt-2 text-green-600';
            setTimeout(() => { settingsStatus.textContent = ''; settingsStatus.className = 'text-sm mt-2'; }, 3000);
            populateByggepladsDropdown(); 
            updateGoogleSheetsButtonStatus(); 
            closeSettingsModal();
        }

        function loadSettings() {
            const storedSettings = localStorage.getItem('timeRegSettings');
            if (storedSettings) {
                settings = JSON.parse(storedSettings);
                settings.employeeName = settings.employeeName || '';
                settings.siteLocationsRaw = settings.siteLocationsRaw || '';
                settings.siteLocations = parseSiteLocations(settings.siteLocationsRaw);
                employeeNameInput.value = settings.employeeName;
                siteLocationsSettingsTextarea.value = settings.siteLocationsRaw;
            } else {
                 settings = { employeeName: '', siteLocationsRaw: '', siteLocations: [] };
            }
            populateByggepladsDropdown(); 
            updateGoogleSheetsButtonStatus(); 
        }

        function updateGoogleSheetsButtonStatus() { 
            sendToGoogleSheetsBtn.disabled = !settings.employeeName; 
            googleSheetStatus.textContent = sendToGoogleSheetsBtn.disabled ? 'Udfyld og gem medarbejdernavn i indstillinger for at sende til Google Sheets.' : '';
        }

        // --- Modal Controls ---
        function openSettingsModal() { settingsModal.style.display = 'flex'; }
        function closeSettingsModal() { settingsModal.style.display = 'none'; }
        openSettingsModalBtn.onclick = openSettingsModal;
        closeSettingsModalBtn.onclick = closeSettingsModal;
        
        function openFreeDayTypeModal() { 
            freeDayTypeError.textContent = '';
            friTimerInput.value = ''; 
            freeDayTypeModal.style.display = 'flex'; 
        }
        function closeFreeDayTypeModal() { freeDayTypeModal.style.display = 'none'; }
        closeFreeDayTypeModalBtn.onclick = closeFreeDayTypeModal;
        registerFreeBtn.onclick = openFreeDayTypeModal;


        // --- Hjælpefunktioner (Dato, Tid, Uge) ---
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        function populateTimeDropdowns(selectedDate) {
            const interval = 30; 
            startTidSelect.innerHTML = '';
            slutTidSelect.innerHTML = '';

            const dayEntries = weeklyEntries.filter(entry => entry.dato === selectedDate && entry.id !== currentlyEditingId && entry.startTid && entry.slutTid);
            const bookedSlots = dayEntries.map(entry => ({
                start: timeToMinutes(entry.startTid),
                end: timeToMinutes(entry.slutTid)
            }));

            for (let minutes = 6 * 60; minutes <= 17 * 60; minutes += interval) {
                const slotStart = minutes;
                const slotEnd = minutes + interval; 
                let isSlotBooked = false;

                for (const booked of bookedSlots) {
                    if (slotStart < booked.end && slotEnd > booked.start) {
                        isSlotBooked = true; 
                        break; 
                    }
                }
                
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                const timeString = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
                
                const optionStart = document.createElement('option');
                optionStart.value = timeString;
                
                if (isSlotBooked) {
                    optionStart.textContent = `${timeString} (Optaget)`;
                    optionStart.classList.add('time-slot-booked'); 
                } else {
                    optionStart.textContent = timeString;
                    optionStart.classList.add('time-slot-available');
                }
                startTidSelect.appendChild(optionStart);
            }
            filterSlutTidOptions();
        }
        
        function filterSlutTidOptions() {
            const selectedStartTid = startTidSelect.value.replace(" (Optaget)", ""); 
            const selectedDate = datoInput.value;
            slutTidSelect.innerHTML = ''; 

            if (!selectedStartTid || !selectedDate) return;

            const startMinutes = timeToMinutes(selectedStartTid);
            const interval = 30;

            const dayEntries = weeklyEntries.filter(entry => entry.dato === selectedDate && entry.id !== currentlyEditingId && entry.startTid && entry.slutTid);
            const bookedSlots = dayEntries.map(entry => ({
                start: timeToMinutes(entry.startTid),
                end: timeToMinutes(entry.slutTid)
            }));

            for (let minutes = startMinutes + interval; minutes <= 17 * 60 + interval ; minutes += interval) {
                 if (minutes > (17*60 + 30)) continue; 

                const currentIntervalStart = startMinutes; 
                const currentIntervalEnd = minutes;   
                let isPathToThisEndBooked = false;

                for (const booked of bookedSlots) {
                    if (booked.start > startMinutes && booked.start < currentIntervalEnd) { 
                        isPathToThisEndBooked = true;
                        break;
                    }
                }
                
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                const timeString = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
                const option = document.createElement('option');
                option.value = timeString;
                option.textContent = timeString;

                if (isPathToThisEndBooked) {
                    option.textContent = `${timeString} (Blokeret)`;
                    option.classList.add('time-slot-blocked');
                    option.disabled = true; 
                } else {
                    option.classList.add('time-slot-available');
                }
                slutTidSelect.appendChild(option);
            }
             if (slutTidSelect.options.length === 0 && selectedStartTid) {
                const option = document.createElement('option');
                option.textContent = "-- Ingen ledige sluttider --";
                option.disabled = true;
                slutTidSelect.appendChild(option);
            }
        }

        function getWeekNumber(d) { 
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        function getDayName(dateString, locale = 'da-DK') { 
            const date = new Date(dateString + 'T12:00:00');
            return date.toLocaleDateString(locale, { weekday: 'long' });
        }
        function getDayOfWeek(dateString) { 
            const date = new Date(dateString + 'T12:00:00'); return (date.getDay() + 6) % 7;
        }
        function timeToMinutes(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number); return hours * 60 + minutes;
        }
        
        function calculateDuration(startStr, endStr, pause9, pause12) {
            if (!startStr || !endStr) return 0;
            const cleanStartStr = startStr.replace(" (Optaget)", "");
            const cleanEndStr = endStr.replace(/ \(Optaget\)|\(Blokeret\)/g, "");

            const startMinutes = timeToMinutes(cleanStartStr);
            const endMinutes = timeToMinutes(cleanEndStr);

            if (endMinutes <= startMinutes) return 0;

            let grossDurationMinutes = endMinutes - startMinutes;
            let pauseDurationMinutes = 0;

            if (pause9) {
                const pause9Start = 9 * 60; const pause9End = 9 * 60 + 30;
                if (startMinutes < pause9End && endMinutes > pause9Start) {
                    pauseDurationMinutes += 30;
                }
            }
            if (pause12) {
                const pause12Start = 12 * 60; const pause12End = 12 * 60 + 30;
                if (startMinutes < pause12End && endMinutes > pause12Start) {
                    pauseDurationMinutes += 30; 
                }
            }
            const netDurationMinutes = grossDurationMinutes - pauseDurationMinutes;
            return netDurationMinutes > 0 ? netDurationMinutes / 60 : 0;
        }

        // --- Dynamiske Dropdown Funktioner ---
        function populateByggepladsDropdown() { 
            const currentValue = byggepladsSelect.value;
            byggepladsSelect.innerHTML = '<option value="">-- Vælg Byggeplads --</option>';
            
            settings.siteLocations.forEach(siteInfo => {
                const option = document.createElement('option');
                option.value = siteInfo.site; option.textContent = siteInfo.site;
                byggepladsSelect.appendChild(option);
            });
            standardByggepladsOptionsForForm.forEach(stdOption => { 
                 const option = document.createElement('option');
                 option.value = stdOption; option.textContent = stdOption;
                 byggepladsSelect.appendChild(option);
            });
            const addNewOption = document.createElement('option');
            addNewOption.value = "ADD_NEW_SITE";
            addNewOption.textContent = "Tilføj ny byggeplads...";
            byggepladsSelect.appendChild(addNewOption);
            
            if (currentValue && Array.from(byggepladsSelect.options).some(opt => opt.value === currentValue)) {
                byggepladsSelect.value = currentValue;
            } else if (settings.siteLocations.length > 0 && !standardByggepladsOptionsForForm.includes(currentValue) && currentValue !== "ADD_NEW_SITE") {
            }
            updatePlaceringOptions();
        }

        function updatePlaceringOptions() { 
            const selectedSiteName = byggepladsSelect.value;
            const currentPlaceringValue = placeringSelect.value;
            placeringSelect.innerHTML = ''; placeringSelect.disabled = true;

            if (!selectedSiteName || selectedSiteName === "ADD_NEW_SITE" || standardByggepladsOptionsForForm.includes(selectedSiteName)) {
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = (selectedSiteName && selectedSiteName !== "ADD_NEW_SITE") ? '-- Ikke relevant --' : '-- Vælg Byggeplads Først --';
                placeringSelect.appendChild(defaultOption); return;
            }

            const siteInfo = settings.siteLocations.find(s => s.site === selectedSiteName);
            placeringSelect.disabled = false;
            const defaultSelectOption = document.createElement('option');
            defaultSelectOption.value = ""; defaultSelectOption.textContent = "-- Vælg Placering --";
            placeringSelect.appendChild(defaultSelectOption);

            if (siteInfo && siteInfo.locations.length > 0) {
                siteInfo.locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location; option.textContent = location;
                    placeringSelect.appendChild(option);
                });
            }
            const addNewPlaceringOption = document.createElement('option');
            addNewPlaceringOption.value = "ADD_NEW_PLACERING";
            addNewPlaceringOption.textContent = "Tilføj ny placering...";
            placeringSelect.appendChild(addNewPlaceringOption);
            
            if (currentPlaceringValue && Array.from(placeringSelect.options).some(opt => opt.value === currentPlaceringValue)) {
                placeringSelect.value = currentPlaceringValue;
            } else if (siteInfo && siteInfo.locations.length > 0) {
            }
        }

        function handleAddNewSite() {
            const newSiteName = prompt("Indtast navn på ny byggeplads:");
            if (newSiteName && newSiteName.trim() !== "") {
                const trimmedName = newSiteName.trim();
                if (!settings.siteLocations.find(s => s.site.toLowerCase() === trimmedName.toLowerCase())) {
                    settings.siteLocations.unshift({ site: trimmedName, locations: [] }); 
                    settings.siteLocationsRaw = formatSiteLocations(settings.siteLocations); 
                    siteLocationsSettingsTextarea.value = settings.siteLocationsRaw; 
                    localStorage.setItem('timeRegSettings', JSON.stringify(settings)); 
                    populateByggepladsDropdown();
                    byggepladsSelect.value = trimmedName; 
                    updatePlaceringOptions(); 
                } else {
                    alert("Denne byggeplads findes allerede.");
                    byggepladsSelect.value = trimmedName; 
                }
            } else {
                byggepladsSelect.value = ""; 
            }
        }
        
        function formatSiteLocations(siteData) { 
            return siteData.map(item => {
                return `${item.site}: ${item.locations.join(', ')}`;
            }).join('\n');
        }


        function handleAddNewPlacering() {
            const selectedSiteName = byggepladsSelect.value;
            if (!selectedSiteName || selectedSiteName === "ADD_NEW_SITE" || standardByggepladsOptionsForForm.includes(selectedSiteName)) {
                alert("Vælg venligst en gyldig byggeplads først.");
                placeringSelect.value = "";
                return;
            }

            const newPlaceringName = prompt(`Indtast navn på ny placering for "${selectedSiteName}":`);
            if (newPlaceringName && newPlaceringName.trim() !== "") {
                const trimmedPlacering = newPlaceringName.trim();
                const siteInfo = settings.siteLocations.find(s => s.site === selectedSiteName);
                if (siteInfo) {
                    if (!siteInfo.locations.find(loc => loc.toLowerCase() === trimmedPlacering.toLowerCase())) {
                        siteInfo.locations.unshift(trimmedPlacering); 
                        settings.siteLocationsRaw = formatSiteLocations(settings.siteLocations);
                        siteLocationsSettingsTextarea.value = settings.siteLocationsRaw; 
                        localStorage.setItem('timeRegSettings', JSON.stringify(settings));
                        updatePlaceringOptions(); 
                        placeringSelect.value = trimmedPlacering; 
                    } else {
                        alert("Denne placering findes allerede for den valgte byggeplads.");
                        placeringSelect.value = trimmedPlacering;
                    }
                }
            } else {
                placeringSelect.value = ""; 
            }
        }


        // --- Status & UI Opdateringer ---
        function showStatusMessage(message, type = 'success', element = statusMessage) { 
             element.textContent = message;
             element.className = `my-2 p-3 rounded-md text-sm ${type === 'success' ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-red-100 text-red-700 border border-red-300'}`;
             setTimeout(() => {
                 if (element.textContent === message) {
                     element.textContent = '';
                      element.className = element === quickEntryError ? 'error-message md:col-span-3' : (element === googleSheetStatus ? 'mt-4' : 'mt-4');
                 }
             }, 5000);
        }
        function toggleNoEntriesMessage() { 
            noEntriesMessage.style.display = weeklyEntries.length === 0 ? 'block' : 'none';
            entriesTable.style.display = weeklyEntries.length === 0 ? 'none' : 'table';
        }

        // --- Kern Funktionalitet (Tilføj, Slet, Render, Rediger) ---
        function renderEntries() {
            entriesBody.innerHTML = ''; 
            
            if (weeklyEntries.length === 0) {
                toggleNoEntriesMessage();
                return;
            }

            const entriesByWeek = weeklyEntries.reduce((acc, entry) => {
                const week = entry.uge;
                (acc[week] = acc[week] || []).push(entry);
                return acc;
            }, {});

            const sortedWeeks = Object.keys(entriesByWeek).sort((a, b) => parseInt(a) - parseInt(b));

            sortedWeeks.forEach(weekKey => {
                const weekEntries = entriesByWeek[weekKey];
                let weeklyTotalHours = 0;
                weekEntries.forEach(e => weeklyTotalHours += e.timer);

                const weekHeaderRow = entriesBody.insertRow();
                weekHeaderRow.classList.add('week-header-row');
                weekHeaderRow.dataset.week = weekKey;
                let cell = weekHeaderRow.insertCell();
                cell.innerHTML = `<i class="fas fa-caret-right toggle-icon"></i> Uge ${weekKey} (${weeklyTotalHours.toFixed(2)} timer)`;
                cell.colSpan = entriesTable.tHead.rows[0].cells.length; 
                cell.addEventListener('click', () => toggleWeekVisibility(weekKey));

                const entriesByDay = weekEntries.reduce((acc, entry) => {
                    (acc[entry.dato] = acc[entry.dato] || []).push(entry);
                    return acc;
                }, {});
                const sortedDaysInWeek = Object.keys(entriesByDay).sort((a,b) => new Date(a) - new Date(b));

                sortedDaysInWeek.forEach(dateKey => {
                    const dayEntries = entriesByDay[dateKey];
                    let dailyTotalHours = 0;
                    dayEntries.forEach(e => dailyTotalHours += e.timer);

                    const dayHeaderRow = entriesBody.insertRow();
                    dayHeaderRow.classList.add('day-header-row', `week-detail-${weekKey}`);
                    dayHeaderRow.style.display = 'none'; 
                    dayHeaderRow.dataset.date = dateKey;
                    dayHeaderRow.dataset.parentWeek = weekKey;
                    
                    let dayCell1 = dayHeaderRow.insertCell(); 
                    dayCell1.innerHTML = "&nbsp;"; 

                    let dayCell2 = dayHeaderRow.insertCell();
                    dayCell2.innerHTML = `<i class="fas fa-caret-right toggle-icon"></i> ${getDayName(dateKey)} (${dailyTotalHours.toFixed(2)} timer)`;
                    dayCell2.colSpan = entriesTable.tHead.rows[0].cells.length -1;
                    dayCell2.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        toggleDayVisibility(dateKey, weekKey);
                    });


                    dayEntries.sort((a,b) => timeToMinutes(a.startTid) - timeToMinutes(b.startTid));
                    dayEntries.forEach((entry) => {
                        const row = entriesBody.insertRow();
                        row.classList.add('entry-row', `week-detail-${weekKey}`, `day-detail-${dateKey}`);
                        row.style.display = 'none'; 

                        const dateObj = new Date(entry.dato + 'T12:00:00');
                        const formattedDate = dateObj.toLocaleDateString('da-DK', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        
                        let pauseText = "";
                        if (entry.pause9 && entry.pause12) pauseText = "60m";
                        else if (entry.pause9 || entry.pause12) pauseText = "30m";
                        else pauseText = "0m";

                        row.insertCell().textContent = formattedDate;
                        row.insertCell().textContent = entry.uge;
                        row.insertCell().textContent = entry.dag;
                        row.insertCell().textContent = entry.byggeplads;
                        row.insertCell().textContent = entry.placering || '-';
                        row.insertCell().textContent = entry.opgave;
                        row.insertCell().textContent = entry.startTid || '-';
                        row.insertCell().textContent = entry.slutTid || '-';
                        row.insertCell().textContent = pauseText;
                        row.insertCell().textContent = entry.timer.toFixed(2);
                        row.insertCell().textContent = entry.ekstraarbejde ? 'Ja' : 'Nej';
                        const materialerCell = row.insertCell();
                        materialerCell.textContent = entry.materialer && entry.materialer.length > 10 ? entry.materialer.substring(0, 10) + '...' : entry.materialer;
                        if (entry.materialer && entry.materialer.length > 10) materialerCell.title = entry.materialer;

                        const beskrivelseCell = row.insertCell();
                        beskrivelseCell.textContent = entry.beskrivelse.length > 10 ? entry.beskrivelse.substring(0, 10) + '...' : entry.beskrivelse;
                        if (entry.beskrivelse.length > 10) { beskrivelseCell.title = entry.beskrivelse; }
                        
                        const actionsCell = row.insertCell();
                        const editButton = document.createElement('i');
                        editButton.classList.add('fas', 'fa-pencil', 'text-blue-600', 'hover:text-blue-800');
                        editButton.onclick = (e) => { e.stopPropagation(); loadEntryForEdit(entry.id);};
                        actionsCell.appendChild(editButton);

                        const deleteButton = document.createElement('i');
                        deleteButton.classList.add('fas', 'fa-trash-can', 'text-red-600', 'hover:text-red-800');
                        deleteButton.onclick = (e) => { e.stopPropagation(); deleteEntry(entry.id);};
                        actionsCell.appendChild(deleteButton);
                    });
                });
            });
            
            saveEntriesToLocalStorage();
            toggleNoEntriesMessage();
        }

        function toggleWeekVisibility(weekKey) {
            const weekRows = document.querySelectorAll(`.week-detail-${weekKey}`);
            const icon = document.querySelector(`.week-header-row[data-week="${weekKey}"] .toggle-icon`);
            const isHidden = weekRows[0] && weekRows[0].style.display === 'none';

            weekRows.forEach(row => {
                if (row.classList.contains('day-header-row')) {
                    row.style.display = isHidden ? 'table-row' : 'none';
                }
                if (!isHidden && row.classList.contains('entry-row')) {
                    row.style.display = 'none';
                }
                if(!isHidden && row.classList.contains('day-header-row')){
                    const dayIcon = row.querySelector('.toggle-icon');
                    if(dayIcon) dayIcon.classList.remove('expanded');
                }
            });
            if (icon) icon.classList.toggle('expanded', isHidden);
        }

        function toggleDayVisibility(dateKey, weekKey) {
            const dayRows = document.querySelectorAll(`.day-detail-${dateKey}.week-detail-${weekKey}`);
            const icon = document.querySelector(`.day-header-row[data-date="${dateKey}"] .toggle-icon`);
            const isHidden = dayRows[0] && dayRows[0].style.display === 'none';

            dayRows.forEach(row => {
                row.style.display = isHidden ? 'table-row' : 'none';
            });
            if (icon) icon.classList.toggle('expanded', isHidden);
        }

        
        function createEntryObject(formData) {
            const entryDate = new Date(formData.dato + 'T12:00:00');
            const timerToUse = (typeof formData.timer === 'number' && formData.timer !== -1) 
                ? formData.timer
                : calculateDuration(formData.startTid, formData.slutTid, formData.pause9, formData.pause12);

            return {
                id: formData.id || Date.now() + Math.random(), 
                dato: formData.dato,
                uge: getWeekNumber(entryDate),
                dag: getDayName(formData.dato),
                byggeplads: formData.byggeplads || '',
                placering: formData.placering || '',
                opgave: formData.opgave || '',
                startTid: formData.startTid ? formData.startTid.replace(" (Optaget)", "") : null, 
                slutTid: formData.slutTid ? formData.slutTid.replace(/ \(Optaget\)|\(Blokeret\)/g, "") : null,
                pause9: formData.pause9 || false,
                pause12: formData.pause12 || false,
                timer: timerToUse, 
                ekstraarbejde: formData.ekstraarbejde || false,
                materialer: formData.materialer || '',
                beskrivelse: formData.beskrivelse || ''
            };
        }

         function handleFormSubmit(event) {
             event.preventDefault(); formError.textContent = '';
             const startTidValue = startTidSelect.value.replace(" (Optaget)", ""); 
             const slutTidValue = slutTidSelect.value.replace(/ \(Optaget\)|\(Blokeret\)/g, "");
             const dato = datoInput.value; const byggeplads = byggepladsSelect.value;
             const placering = placeringSelect.disabled ? '' : placeringSelect.value;

             if (!dato) { formError.textContent = 'Vælg venligst en dato.'; return; }
             if (!byggeplads || byggeplads === "ADD_NEW_SITE") { 
                 formError.textContent = 'Vælg venligst en byggeplads.'; return;
             }
             
             if (standardByggepladsOptionsForForm.includes(byggeplads) && (byggeplads === "Syg" || byggeplads === "Fri" || byggeplads === "Ferie")) {
                 formError.textContent = `Brug knapperne under "Hurtig Registrering" for ${byggeplads}.`; return;
             }

             if (!startTidValue || !slutTidValue) {
                 formError.textContent = 'Udfyld venligst starttid og sluttid.'; return;
             }
             if (!placeringSelect.disabled && (!placering || placering === "ADD_NEW_PLACERING")) {
                 formError.textContent = 'Vælg venligst en placering for den valgte byggeplads.'; return;
             }
             
             const calculatedTimer = calculateDuration(startTidValue, slutTidValue, pause9Checkbox.checked, pause12Checkbox.checked);
             if (timeToMinutes(slutTidValue) <= timeToMinutes(startTidValue)) {
                 formError.textContent = 'Sluttid skal være efter starttid.'; return;
             }
             
             const dayEntries = weeklyEntries.filter(entry => entry.dato === dato && entry.id !== currentlyEditingId && entry.startTid && entry.slutTid);
             const startMinutes = timeToMinutes(startTidValue);
             const endMinutes = timeToMinutes(slutTidValue);
             for (const booked of dayEntries.map(e => ({start: timeToMinutes(e.startTid), end: timeToMinutes(e.slutTid)}))) {
                 if (startMinutes < booked.end && endMinutes > booked.start) {
                     formError.textContent = 'Den valgte tid overlapper med en eksisterende registrering.';
                     return;
                 }
             }

             const entryData = {
                 id: currentlyEditingId,
                 dato: dato, byggeplads: byggeplads,
                 placering: placering === "Andet (specificer)" ? "Andet (specificer)" : placering,
                 opgave: opgaveInput.value.trim(),
                 startTid: startTidValue, slutTid: slutTidValue,
                 pause9: pause9Checkbox.checked, pause12: pause12Checkbox.checked,
                 timer: calculatedTimer, 
                 ekstraarbejde: ekstraarbejdeCheckbox.checked,
                 materialer: materialerInput.value.trim(),
                 beskrivelse: beskrivelseInput.value.trim()
             };
             
             const newOrUpdatedEntry = createEntryObject(entryData);

             if (currentlyEditingId) {
                 const index = weeklyEntries.findIndex(e => e.id === currentlyEditingId);
                 if (index > -1) {
                     weeklyEntries[index] = newOrUpdatedEntry;
                 }
                 showStatusMessage('Post opdateret succesfuldt!');
             } else {
                 weeklyEntries.push(newOrUpdatedEntry);
                 showStatusMessage('Post tilføjet succesfuldt!');
             }
             
             lastSelectedByggeplads = byggeplads; 
             lastSelectedPlacering = placeringSelect.disabled ? '' : placering;

             resetFormAndEditingState();
             renderEntries();
         }

        function loadEntryForEdit(entryId) {
            const entry = weeklyEntries.find(e => e.id === entryId);
            if (!entry) return;

            currentlyEditingId = entryId;
            formHeading.textContent = "Rediger Registrering";
            submitBtn.textContent = "Gem Ændringer";
            cancelEditBtn.style.display = 'inline-block';

            datoInput.value = entry.dato;
            byggepladsSelect.value = entry.byggeplads;
            updatePlaceringOptions(); 
            placeringSelect.value = entry.placering || ""; 
            
            opgaveInput.value = entry.opgave;
            
            populateTimeDropdowns(entry.dato); 

            if (entry.startTid) {
                let cleanStartTime = entry.startTid.replace(" (Optaget)", "");
                let startOptionExists = Array.from(startTidSelect.options).some(opt => opt.value === cleanStartTime || opt.value === entry.startTid);
                if (!startOptionExists) { 
                    const opt = document.createElement('option'); opt.value = cleanStartTime; opt.textContent = cleanStartTime;
                    startTidSelect.insertBefore(opt, startTidSelect.firstChild); 
                }
                startTidSelect.value = cleanStartTime; 
            }
            
            filterSlutTidOptions(); 
            
             if (entry.slutTid) {
                 let cleanEndTime = entry.slutTid.replace(/ \(Optaget\)|\(Blokeret\)/g, "");
                 let endOptionExists = Array.from(slutTidSelect.options).some(opt => opt.value === cleanEndTime || opt.value === entry.slutTid);
                 if(!endOptionExists){
                    const opt = document.createElement('option'); opt.value = cleanEndTime; opt.textContent = cleanEndTime;
                    slutTidSelect.insertBefore(opt, slutTidSelect.firstChild);
                 }
                slutTidSelect.value = cleanEndTime; 
            }

            pause9Checkbox.checked = entry.pause9 || false;
            pause12Checkbox.checked = entry.pause12 || false;
            ekstraarbejdeCheckbox.checked = entry.ekstraarbejde || false;
            materialerInput.value = entry.materialer || '';
            beskrivelseInput.value = entry.beskrivelse || '';
            
            window.scrollTo({ top: timeRegistrationForm.offsetTop - 20, behavior: 'smooth' });
        }

        function resetFormAndEditingState() {
            timeRegistrationForm.reset();
            currentlyEditingId = null;
            formHeading.textContent = "Normal Registrering";
            submitBtn.textContent = "Tilføj Post";
            cancelEditBtn.style.display = 'none';
            
            datoInput.value = getTodayString(); 
            
            if (lastSelectedByggeplads) {
                byggepladsSelect.value = lastSelectedByggeplads; 
            } else {
                byggepladsSelect.value = ""; 
            }
            updatePlaceringOptions(); 
            if (lastSelectedPlacering && !placeringSelect.disabled) {
                placeringSelect.value = lastSelectedPlacering;
            } else {
                 placeringSelect.value = "";
            }
            populateTimeDropdowns(datoInput.value);
        }


         function registerAbsence(type, hours = null) { 
             quickEntryError.textContent = ''; 
             freeDayTypeError.textContent = '';
             const dato = quickEntryDateInput.value;

             if (!dato) { 
                 showStatusMessage('Vælg venligst en dato for fravær.', 'error', quickEntryError);
                 return; 
            }
             const dayOfWeek = getDayOfWeek(dato);
             if (dayOfWeek >= 5 && (type === 'sick' || type === 'ferie-hele-dage')) { 
                 showStatusMessage('Syg/Ferie kan kun registreres på hverdage (man-fre).', 'error', quickEntryError);
                 return;
             }
             
             let timerValue;
             let description;
             let byggepladsVal;

             if (type === 'sick') {
                 timerValue = (dayOfWeek === 4) ? 5 : 8;
                 description = "Syg";
                 byggepladsVal = "Syg";
             } else if (type === 'ferie-hele-dage') {
                 timerValue = (dayOfWeek === 4) ? 5 : 8;
                 description = "Ferie (Hele dage)";
                 byggepladsVal = "Ferie";
             } else if (type === 'fri-timer') {
                 if (hours === null || isNaN(parseFloat(hours)) || parseFloat(hours) <= 0) {
                     showStatusMessage('Indtast venligst et gyldigt antal timer for "Fri (timer)".', 'error', freeDayTypeError);
                     return;
                 }
                 timerValue = parseFloat(hours);
                 description = `Fri (${timerValue} timer)`;
                 byggepladsVal = "Fri";
             } else {
                 return; 
             }
             
             const entryData = createEntryObject({
                 dato: dato, byggeplads: byggepladsVal, placering: '-', opgave: description,
                 startTid: null, slutTid: null, 
                 timer: timerValue, 
                 pause9: false, pause12: false,
                 ekstraarbejde: false, beskrivelse: description, materialer: ''
             });

             weeklyEntries.push(entryData);
             renderEntries();
             populateTimeDropdowns(datoInput.value); 
             showStatusMessage(`${description} registreret for ${new Date(dato + 'T12:00:00').toLocaleDateString('da-DK')}.`);
             closeFreeDayTypeModal(); 
         }

        function deleteEntry(entryId) {
            if (confirm('Er du sikker på, du vil slette denne post?')) {
                const entryDate = weeklyEntries.find(e => e.id === entryId)?.dato;
                weeklyEntries = weeklyEntries.filter(entry => entry.id !== entryId);
                if (currentlyEditingId === entryId) { 
                    resetFormAndEditingState();
                }
                renderEntries();
                if (entryDate === datoInput.value || datoInput.value === getTodayString()) { 
                     populateTimeDropdowns(datoInput.value);
                }
                showStatusMessage('Post slettet.', 'error');
            }
        }

        // --- Lokal Lagring ---
        function saveEntriesToLocalStorage() { 
            localStorage.setItem('weeklyTimeEntries', JSON.stringify(weeklyEntries));
        }
        function loadEntriesFromLocalStorage() { 
            const storedEntries = localStorage.getItem('weeklyTimeEntries');
            if (storedEntries) {
                weeklyEntries = JSON.parse(storedEntries);
                 weeklyEntries.forEach(entry => {
                     entry.id = entry.id || Date.now() + Math.random(); 
                     entry.timer = parseFloat(entry.timer) || 0;
                     entry.ekstraarbejde = !!entry.ekstraarbejde;
                     entry.pause9 = !!entry.pause9;
                     entry.pause12 = !!entry.pause12;
                     entry.materialer = entry.materialer || '';
                 });
            }
        }

        // --- Google Sheets Funktion ---
        async function sendDataToGoogleSheets() {
            googleSheetStatus.textContent = ''; 
            if (!settings.employeeName) {
                showStatusMessage('Udfyld og gem medarbejdernavn i indstillinger først.', 'error', googleSheetStatus);
                openSettingsModal();
                return;
            }
            if (weeklyEntries.length === 0) {
                showStatusMessage('Ingen registreringer at sende.', 'error', googleSheetStatus);
                return;
            }
            if (SCRIPT_URL === "ERSTAT_MED_DIN_GOOGLE_APPS_SCRIPT_WEB_APP_URL" || SCRIPT_URL.includes("ERSTAT_MED_DIN")) {
                showStatusMessage("Google Apps Script URL er ikke konfigureret korrekt. Opdater scriptet med din URL.", "error", googleSheetStatus);
                alert("Du skal først konfigurere Google Apps Script URL'en i HTML-sidens JavaScript (konstanten SCRIPT_URL).\n\nSe vejledningen for opsætning af Google Apps Script, og sørg for at den indsatte URL er korrekt.");
                return;
            }

            sendToGoogleSheetsBtn.disabled = true;
            sendToGoogleSheetsBtn.textContent = "Sender...";

            const dataToSend = weeklyEntries.map(entry => ({
                medarbejderNavn: settings.employeeName, 
                dato: entry.dato,
                uge: entry.uge,
                dag: entry.dag,
                byggeplads: entry.byggeplads,
                placering: entry.placering || '-',
                opgave: entry.opgave || '-',
                startTid: entry.startTid || '-',
                slutTid: entry.slutTid || '-',
                pause9: entry.pause9 ? "Ja" : "Nej",
                pause12: entry.pause12 ? "Ja" : "Nej",
                timer: entry.timer.toFixed(2),
                ekstraarbejde: entry.ekstraarbejde ? "Ja" : "Nej",
                materialer: entry.materialer || '-',
                beskrivelse: entry.beskrivelse || '-'
            }));

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', 
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ entries: dataToSend })
                });
                
                let responseDataText = await response.text(); 
                console.log("Response from Apps Script:", responseDataText);

                if (response.ok) {
                    try {
                        const responseData = JSON.parse(responseDataText); 
                        if (responseData.status === "success") {
                            showStatusMessage('Data sendt succesfuldt til Google Sheets!', 'success', googleSheetStatus);
                        } else {
                            throw new Error(responseData.message || "Ukendt fejl fra Google Apps Script.");
                        }
                    } catch (e) { 
                         console.error("Fejl ved behandling af svar fra Apps Script (ikke-JSON eller forkert format):", e, "Råtekst:", responseDataText);
                         showStatusMessage(`Fejl fra server (svar ikke gyldigt JSON): ${responseDataText.substring(0, 150)}...`, 'error', googleSheetStatus);
                    }
                } else {
                    console.error('Fejl ved afsendelse til Google Sheets:', response.status, response.statusText, responseDataText);
                    showStatusMessage(`Fejl ved afsendelse: ${response.status} ${response.statusText}. Server svar: ${responseDataText.substring(0,150)}...`, 'error', googleSheetStatus);
                }
            } catch (error) {
                console.error('Netværksfejl eller scriptfejl ved afsendelse til Google Sheets:', error);
                showStatusMessage(`Netværksfejl: ${error.message}. Tjek konsollen og Apps Script logs.`, 'error', googleSheetStatus);
            } finally {
                sendToGoogleSheetsBtn.disabled = false;
                sendToGoogleSheetsBtn.textContent = "Send til Google Sheets";
            }
        }
        
        // --- CSV Eksport ---
        function openCsvExportModal() {
            csvExportStatus.textContent = '';
            if (!settings.employeeName) {
                showStatusMessage('Udfyld og gem medarbejdernavn i indstillinger først.', 'error', csvExportStatus);
                openSettingsModal();
                return;
            }
            if (weeklyEntries.length === 0) {
                showStatusMessage('Ingen data at eksportere.', 'error', csvExportStatus);
                return;
            }

            const uniqueWeeks = [...new Set(weeklyEntries.map(entry => entry.uge))].sort((a,b) => a - b);
            csvWeekCheckboxesContainer.innerHTML = '';
            uniqueWeeks.forEach(weekNr => {
                const label = document.createElement('label');
                label.classList.add('block', 'mb-1', 'cursor-pointer');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = weekNr;
                checkbox.checked = false;
                checkbox.classList.add('mr-2', 'form-checkbox');
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` Uge ${weekNr}`));
                csvWeekCheckboxesContainer.appendChild(label);
            });

            csvByggepladsSelect.innerHTML = '<option value="">-- Alle Byggepladser --</option>';
            const uniqueSites = [...new Set(weeklyEntries.map(entry => entry.byggeplads))].sort();
            uniqueSites.forEach(siteName => {
                if (siteName && !standardByggepladsOptionsForForm.includes(siteName) && siteName !== "Syg" && siteName !== "Fri" && siteName !== "Ferie") {
                    const option = document.createElement('option');
                    option.value = siteName;
                    option.textContent = siteName;
                    csvByggepladsSelect.appendChild(option);
                }
            });

            csvExportModal.style.display = 'flex';
        }

        function closeCsvExportModal() {
            csvExportModal.style.display = 'none';
        }
        
        function processAndExportCSV() {
            const selectedWeekNumbers = [];
            csvWeekCheckboxesContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                selectedWeekNumbers.push(parseInt(checkbox.value));
            });
            const selectedByggeplads = csvByggepladsSelect.value;

            let filteredEntries = [...weeklyEntries];

            if (selectedWeekNumbers.length > 0) {
                filteredEntries = filteredEntries.filter(entry => selectedWeekNumbers.includes(entry.uge));
            }
            if (selectedByggeplads) {
                filteredEntries = filteredEntries.filter(entry => entry.byggeplads === selectedByggeplads);
            }

            if (filteredEntries.length === 0) {
                showStatusMessage("Ingen data matcher de valgte filtre for eksport.", "error", csvExportStatus);
                return;
            }
            closeCsvExportModal();

            const headers = ["Dato", "Uge", "Dag", "Byggeplads", "Placering", "Opgave", "Starttid", "Sluttid", "Pause kl. 9", "Pause kl. 12", "Timer (Netto)", "Ekstraarbejde", "Materialer", "Beskrivelse"];
            let csvContent = headers.join(";") + "\n"; 

            const sortedEntriesForCsv = filteredEntries.sort((a,b) => {
                 const dateComp = new Date(a.dato) - new Date(b.dato);
                if (dateComp !== 0) return dateComp;
                return timeToMinutes(a.startTid) - timeToMinutes(b.startTid);
            });

            sortedEntriesForCsv.forEach(entry => {
                const row = [
                    new Date(entry.dato + 'T12:00:00').toLocaleDateString('da-DK'), 
                    entry.uge,
                    entry.dag,
                    `"${entry.byggeplads.replace(/"/g, '""')}"`, 
                    `"${(entry.placering || '-').replace(/"/g, '""')}"`,
                    `"${(entry.opgave || '-').replace(/"/g, '""')}"`,
                    entry.startTid || '-',
                    entry.slutTid || '-',
                    entry.pause9 ? "Ja" : "Nej",
                    entry.pause12 ? "Ja" : "Nej",
                    entry.timer.toFixed(2).replace('.',','), 
                    entry.ekstraarbejde ? "Ja" : "Nej",
                    `"${(entry.materialer || '-').replace(/"/g, '""')}"`,
                    `"${(entry.beskrivelse || '-').replace(/"/g, '""')}"`
                ];
                csvContent += row.join(";") + "\n";
            });

            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `tidsregistrering_${settings.employeeName.replace(/\s+/g, '_') || 'export'}_${getTodayString()}_filtreret.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showStatusMessage("CSV-fil genereret og download startet.", "success", csvExportStatus);
            } else {
                showStatusMessage("CSV eksport understøttes ikke fuldt ud af din browser.", "error", csvExportStatus);
            }
        }


        // --- Event Listeners ---
        settingsForm.addEventListener('submit', saveSettings);
        timeRegistrationForm.addEventListener('submit', handleFormSubmit);
        cancelEditBtn.addEventListener('click', resetFormAndEditingState);
        
        sendToGoogleSheetsBtn.addEventListener('click', sendDataToGoogleSheets); 
        
        exportCsvBtnModal.addEventListener('click', openCsvExportModal);
        confirmCsvExportBtn.addEventListener('click', processAndExportCSV);
        cancelCsvExportBtn.addEventListener('click', closeCsvExportModal);
        closeCsvExportModalBtn.addEventListener('click', closeCsvExportModal);


        registerSickBtn.addEventListener('click', () => registerAbsence('sick'));
        registerFerieHeleDageBtn.addEventListener('click', () => registerAbsence('ferie-hele-dage'));
        registerFriTimerBtn.addEventListener('click', () => {
            const hours = friTimerInput.value;
            registerAbsence('fri-timer', hours);
        });


        byggepladsSelect.addEventListener('change', (event) => {
            if (event.target.value === "ADD_NEW_SITE") {
                handleAddNewSite();
            } else {
                updatePlaceringOptions();
                lastSelectedPlacering = ''; 
                placeringSelect.value = '';
            }
        });
        placeringSelect.addEventListener('change', (event) => {
            if (event.target.value === "ADD_NEW_PLACERING") {
                handleAddNewPlacering();
            }
        });

        datoInput.addEventListener('change', () => populateTimeDropdowns(datoInput.value));
        startTidSelect.addEventListener('change', filterSlutTidOptions);


        // --- Initialisering ved sideindlæsning ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = getTodayString();
            datoInput.value = today;
            quickEntryDateInput.value = today;

            loadSettings(); 
            populateTimeDropdowns(today);
            
            loadEntriesFromLocalStorage();
            renderEntries();
            
            if (weeklyEntries.length > 0 && !datoInput.value) { 
                 datoInput.value = weeklyEntries[weeklyEntries.length - 1].dato;
                 populateTimeDropdowns(datoInput.value);
            }
            
            if (lastSelectedByggeplads) byggepladsSelect.value = lastSelectedByggeplads;
            updatePlaceringOptions(); 
            if (lastSelectedPlacering && !placeringSelect.disabled && Array.from(placeringSelect.options).some(opt => opt.value === lastSelectedPlacering)) {
                placeringSelect.value = lastSelectedPlacering;
            } else {
                placeringSelect.value = ""; 
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js') 
                .then(function(registration) {
                    console.log('Service Worker registreret med scope:', registration.scope);
                }).catch(function(error) {
                    console.log('Service Worker registrering fejlede:', error);
                });
            }

        });

    </script>
</body>
</html>
