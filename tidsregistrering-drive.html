<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidsregistrering</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tidsreg">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png"> 
    <meta name="theme-color" content="#4f46e5">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 800px; margin: 2rem auto; padding: 2rem; background-color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); position: relative; }
        .version-number { position: absolute; bottom: 5px; right: 10px; font-size: 0.7rem; color: #9ca3af; }
        .form-input, .form-select, .form-textarea, .form-checkbox { border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; width: 100%; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25); }
        .form-checkbox { width: auto; padding: 0; margin-right: 0.5rem; margin-left:0.25rem; border-radius: 0.25rem; color: #4f46e5; }
        .form-select:disabled, .form-input:disabled { background-color: #e5e7eb; cursor: not-allowed; opacity: 0.7; }
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.15s ease-in-out; cursor: pointer; text-align: center; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary, .btn-success, .btn-info, .btn-warning, .btn-secondary { color: white; }
        .btn-primary { background-color: #4f46e5; } .btn-primary:hover:not(:disabled) { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; } .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-success { background-color: #16a34a; } .btn-success:hover:not(:disabled) { background-color: #15803d; }
        .btn-warning { background-color: #f59e0b; } .btn-warning:hover:not(:disabled) { background-color: #d97706; }
        .btn-info { background-color: #3b82f6; } .btn-info:hover:not(:disabled) { background-color: #2563eb; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        th, td { border: 1px solid #e5e7eb; padding: 0.4rem; text-align: left; font-size: 0.75rem; vertical-align: top; }
        th { background-color: #f9fafb; font-weight: 600; white-space: nowrap; }
        td .fa-pencil, td .fa-trash-can { cursor: pointer; margin-right: 8px; }
        .week-header-row, .day-header-row { cursor: pointer; user-select: none; }
        .week-header-row td, .day-header-row td { background-color: #f3f4f6; font-weight: bold; }
        .day-header-row td:first-child { padding-left: 1.5rem; } 
        .entry-row td:first-child { padding-left: 2.5rem; } 
        .toggle-icon { margin-right: 0.5em; transition: transform 0.2s; display: inline-block; }
        .toggle-icon.expanded { transform: rotate(90deg); }
        .error-message { color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; min-height: 1.25rem; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 0.5rem; }
        .modal-close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-700">Tidsregistrering</h1>
            <button id="openSettingsModalBtn" class="btn btn-secondary px-3 py-2"><i class="fas fa-cog"></i></button>
        </div>

        <div id="offline-indicator" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
            <p class="font-bold">Offline</p>
            <p>Du er i øjeblikket offline. Billeder vil blive uploadet, næste gang du har forbindelse.</p>
        </div>

        <form id="timeRegistrationForm" class="space-y-4 mt-6">
             <h3 class="text-lg font-semibold mb-3 text-gray-600" id="formHeading">Registrering</h3>
            <input type="hidden" id="editingEntryId" value="">
            <div>
                <label for="dato" class="block text-sm font-medium text-gray-700">Dato:</label>
                <input type="date" id="dato" name="dato" class="form-input mt-1" required>
            </div>

            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h4 class="text-sm font-medium text-gray-600 mb-2">Registrer Fravær for Hele Dage/Uger</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <button type="button" id="registerSickBtn" class="btn btn-warning w-full">Syg (Hel Dag)</button>
                    <button type="button" id="registerFerieUgeBtn" class="btn btn-info w-full">Ferie (Hel Uge)</button>
                </div>
                <div id="quickEntryError" class="error-message mt-2"></div>
            </div>

            <hr/>
            <h4 class="text-md font-medium text-gray-800 pt-2">Normal Arbejdsdag / Fravær i Timer</h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="byggeplads" class="block text-sm font-medium text-gray-700">Byggeplads / Opgave type:</label>
                    <select id="byggeplads" name="byggeplads" class="form-select mt-1"></select>
                </div>
                 <div>
                    <label for="placering" class="block text-sm font-medium text-gray-700">Placering:</label>
                    <select id="placering" name="placering" class="form-select mt-1" disabled></select>
                </div>
            </div>
             <div>
                <label for="opgave" class="block text-sm font-medium text-gray-700">Opgavebeskrivelse:</label>
                <input type="text" id="opgave" name="opgave" class="form-input mt-1" placeholder="F.eks. Montering af vinduer">
            </div>
            <div id="tidOgPauseContainer">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="startTid" class="block text-sm font-medium text-gray-700">Starttid:</label>
                        <select id="startTid" name="startTid" class="form-select mt-1" required></select>
                    </div>
                    <div>
                        <label for="slutTid" class="block text-sm font-medium text-gray-700">Sluttid:</label>
                        <select id="slutTid" name="slutTid" class="form-select mt-1" required></select>
                    </div>
                </div>
                <div class="mt-2 space-y-2 md:space-y-0 md:flex md:items-center md:space-x-4">
                     <div class="flex items-center">
                         <input type="checkbox" id="pause9" name="pause9" class="form-checkbox h-4 w-4">
                         <label for="pause9" class="ml-1 text-sm font-medium text-gray-700">Pause kl. 9</label>
                     </div>
                     <div class="flex items-center">
                         <input type="checkbox" id="pause12" name="pause12" class="form-checkbox h-4 w-4">
                         <label for="pause12" class="ml-1 text-sm font-medium text-gray-700">Pause kl. 12</label>
                     </div>
                </div>
            </div>
             <div class="flex items-center mt-2">
                 <input type="checkbox" id="ekstraarbejde" name="ekstraarbejde" class="form-checkbox h-4 w-4">
                 <label for="ekstraarbejde" class="ml-1 text-sm font-medium text-gray-700">Ekstraarbejde</label>
             </div>
            <div>
                <label for="materialer" class="block text-sm font-medium text-gray-700">Materialeforbrug:</label>
                <textarea id="materialer" name="materialer" rows="2" class="form-textarea mt-1"></textarea>
            </div>
            <div>
                <label for="imageUpload" class="block text-sm font-medium text-gray-700">Vedhæft Billede (valgfrit):</label>
                <input type="file" id="imageUpload" name="imageUpload" class="form-input mt-1" accept="image/*">
                <div id="imagePreviewContainer" class="mt-2"></div>
            </div>
            <div>
                <label for="beskrivelse" class="block text-sm font-medium text-gray-700">Bemærkninger:</label>
                <textarea id="beskrivelse" name="beskrivelse" rows="2" class="form-textarea mt-1"></textarea>
            </div>
            <div id="formError" class="error-message"></div>
            <div class="flex space-x-2">
                <button type="submit" id="submitBtn" class="btn btn-primary w-full">Tilføj Post</button>
                <button type="button" id="cancelEditBtn" class="btn btn-secondary w-full" style="display:none;">Annuller</button>
            </div>
        </form>
        
        <h2 class="text-xl font-semibold mt-8 mb-4 text-gray-700">Registrerede Timer</h2>
        <div class="overflow-x-auto">
            <table id="entriesTable">
                <thead>
                    <tr>
                        <th>Dato</th><th>Uge</th><th>Dag</th><th>Byggeplads</th><th>Placering</th>
                        <th>Opgave</th><th>Start</th><th>Slut</th><th>Pauser</th><th>Timer</th>
                        <th>Ekstra</th><th>Materialer</th><th>Bemærk.</th><th>Handling</th>
                    </tr>
                </thead>
                <tbody id="entriesBody"></tbody>
            </table>
        </div>
        <div id="noEntriesMessage" class="text-gray-500 mt-4 text-center" style="display: none;">Ingen registreringer endnu.</div>
        
        <div class="mt-6 flex space-x-2">
            <button id="sendEmailBtn" class="btn btn-success w-full">Send Ugeseddel</button>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">Sørg for at indstillinger er gemt før afsendelse.</p>
        <div id="emailStatus" class="mt-2"></div>
        <div class="version-number">v2.1</div>
    </div>

    <!-- Modals -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeSettingsModalBtn">&times;</span>
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Indstillinger</h3>
            <form id="settingsForm" class="space-y-4">
                <div>
                    <label for="recipientEmail" class="block text-sm font-medium text-gray-700">Modtager Email:</label>
                    <input type="email" id="recipientEmail" name="recipientEmail" class="form-input mt-1">
                </div>
                <div>
                    <label for="ccEmail" class="block text-sm font-medium text-gray-700">CC Email (valgfri):</label>
                    <input type="email" id="ccEmail" name="ccEmail" class="form-input mt-1">
                </div>
                <div>
                    <label for="employeeName" class="block text-sm font-medium text-gray-700">Medarbejder Navn:</label>
                    <input type="text" id="employeeName" name="employeeName" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="employeeInitials" class="block text-sm font-medium text-gray-700">Dine Initialer (auto-genereret):</label>
                    <input type="text" id="employeeInitials" name="employeeInitials" class="form-input mt-1" placeholder="f.eks. LJ" readonly>
                </div>
                <div>
                    <label for="siteLocationsSettings" class="block text-sm font-medium text-gray-700">Byggepladser & Placeringer</label>
                    <textarea id="siteLocationsSettings" name="siteLocationsSettings" rows="5" class="form-textarea mt-1"></textarea>
                </div>
                <div class="mt-6">
                     <button type="button" id="exportCsvBtnModal" class="btn btn-info w-full mb-2">Eksporter til CSV</button>
                </div>
                 <button type="submit" class="btn btn-success w-full">Gem Indstillinger</button>
                <div id="settingsStatus" class="text-sm mt-2"></div>
            </form>
        </div>
    </div>
    <div id="ferieUgeModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeFerieUgeModalBtn">&times;</span>
            <h3 class="text-lg font-semibold mb-3">Registrer Ferie for en Hel Uge</h3>
            <div class="space-y-4">
                <div>
                    <label for="ferieAarSelect" class="block text-sm font-medium text-gray-700">Vælg År:</label>
                    <select id="ferieAarSelect" class="form-select mt-1"></select>
                </div>
                <div>
                    <label for="ferieUgeSelect" class="block text-sm font-medium text-gray-700">Vælg Uge:</label>
                    <select id="ferieUgeSelect" class="form-select mt-1"></select>
                </div>
            </div>
            <div id="ferieUgeError" class="error-message mt-3"></div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancelFerieUgeBtn" class="btn btn-secondary">Annuller</button>
                <button id="confirmFerieUgeBtn" class="btn btn-primary">Registrer Uge</button>
            </div>
        </div>
    </div>
    <div id="weekSelectionModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeWeekSelectionModalBtn">&times;</span>
            <h3 class="text-lg font-semibold mb-3">Vælg Uger til Afsendelse</h3>
            <div id="weekCheckboxesContainer" class="mb-4 max-h-60 overflow-y-auto"></div>
            <div class="flex justify-end space-x-2">
                <button id="cancelWeekSelectionBtn" class="btn btn-secondary">Annuller</button>
                <button id="confirmWeekSelectionBtn" class="btn btn-primary">Send Valgte Uger</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Globale Variabler ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx4-mz1MNZ4FY0GBOV1qlWrmUBZQ3X1Jz1v9S4kO8BPr_ZoZZRqfVbCDevk2e24WxqO/exec";
        const allElements = {
            settingsModal: document.getElementById('settingsModal'),
            openSettingsModalBtn: document.getElementById('openSettingsModalBtn'),
            closeSettingsModalBtn: document.getElementById('closeSettingsModalBtn'),
            settingsForm: document.getElementById('settingsForm'),
            timeRegistrationForm: document.getElementById('timeRegistrationForm'),
            formHeading: document.getElementById('formHeading'),
            editingEntryIdInput: document.getElementById('editingEntryId'),
            submitBtn: document.getElementById('submitBtn'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            startTidSelect: document.getElementById('startTid'),
            slutTidSelect: document.getElementById('slutTid'),
            entriesBody: document.getElementById('entriesBody'),
            formError: document.getElementById('formError'),
            settingsStatus: document.getElementById('settingsStatus'),
            statusMessage: document.getElementById('statusMessage'),
            noEntriesMessage: document.getElementById('noEntriesMessage'),
            entriesTable: document.getElementById('entriesTable'),
            sendEmailBtn: document.getElementById('sendEmailBtn'),
            emailStatus: document.getElementById('emailStatus'),
            exportCsvBtnModal: document.getElementById('exportCsvBtnModal'),
            quickEntryError: document.getElementById('quickEntryError'),
            registerSickBtn: document.getElementById('registerSickBtn'),
            registerFerieUgeBtn: document.getElementById('registerFerieUgeBtn'),
            ferieUgeModal: document.getElementById('ferieUgeModal'),
            closeFerieUgeModalBtn: document.getElementById('closeFerieUgeModalBtn'),
            ferieAarSelect: document.getElementById('ferieAarSelect'),
            ferieUgeSelect: document.getElementById('ferieUgeSelect'),
            ferieUgeError: document.getElementById('ferieUgeError'),
            cancelFerieUgeBtn: document.getElementById('cancelFerieUgeBtn'),
            confirmFerieUgeBtn: document.getElementById('confirmFerieUgeBtn'),
            recipientEmailInput: document.getElementById('recipientEmail'),
            ccEmailInput: document.getElementById('ccEmail'),
            employeeNameInput: document.getElementById('employeeName'),
            employeeInitialsInput: document.getElementById('employeeInitials'),
            siteLocationsSettingsTextarea: document.getElementById('siteLocationsSettings'),
            datoInput: document.getElementById('dato'),
            byggepladsSelect: document.getElementById('byggeplads'),
            placeringSelect: document.getElementById('placering'),
            opgaveInput: document.getElementById('opgave'),
            tidOgPauseContainer: document.getElementById('tidOgPauseContainer'),
            pause9Checkbox: document.getElementById('pause9'),
            pause12Checkbox: document.getElementById('pause12'),
            ekstraarbejdeCheckbox: document.getElementById('ekstraarbejde'),
            materialerInput: document.getElementById('materialer'),
            imageUploadInput: document.getElementById('imageUpload'),
            imagePreviewContainer: document.getElementById('imagePreviewContainer'),
            beskrivelseInput: document.getElementById('beskrivelse'),
            offlineIndicator: document.getElementById('offline-indicator'),
            weekSelectionModal: document.getElementById('weekSelectionModal'),
            weekCheckboxesContainer: document.getElementById('weekCheckboxesContainer'),
            cancelWeekSelectionBtn: document.getElementById('cancelWeekSelectionBtn'),
            confirmWeekSelectionBtn: document.getElementById('confirmWeekSelectionBtn'),
            closeWeekSelectionModalBtn: document.getElementById('closeWeekSelectionModalBtn'),
        };

        let weeklyEntries = [];
        let settings = {};
        const standardByggepladsOptionsForForm = ["Fri", "Andet"];
        let lastSelectedByggeplads = '';
        let lastSelectedPlacering = '';
        let currentlyEditingId = null;

        // --- Funktioner ---
        
        function getTodayString() { return new Date().toISOString().split('T')[0]; }
        function getISODateString(date) { return date.toISOString().split('T')[0]; }

        function generateInitials(name) {
            if (!name) return '';
            const nameParts = name.trim().split(' ').filter(p => p);
            if (nameParts.length > 1) {
                return (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
            } else if (nameParts.length === 1 && nameParts[0].length > 1) {
                return (nameParts[0][0] + nameParts[0][1]).toUpperCase();
            }
            return (nameParts[0]?.[0] || '').toUpperCase();
        }
        
        // ... (Alle andre funktioner fra den tidligere version indsættes her) ...
        // Dette inkluderer: parseSiteLocations, saveSettings, loadSettings,
        // open/close modals, populateTimeDropdowns, filterSlutTidOptions,
        // getWeekNumber, getDayName, getDayOfWeek, timeToMinutes, calculateDuration,
        // populateByggepladsDropdown, updatePlaceringOptions, handleAddNewSite,
        // formatSiteLocations, handleAddNewPlacering, showStatusMessage,
        // toggleNoEntriesMessage, renderEntries, toggleWeek/DayVisibility,
        // createEntryObject, handleFormSubmit, loadEntryForEdit, resetFormAndEditingState,
        // registerAbsence, deleteEntry, save/loadEntriesFromLocalStorage,
        // openWeekSelectionModal, closeWeekSelectionModal, processAndSendEmail,
        // openCsvExportModal, closeCsvExportModal, processAndExportCSV,
        // uploadImageAndAddEntry, addEntryToList, syncPendingUploads

        // --- Initialisering ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = getTodayString();
            allElements.datoInput.value = today;
            // allElements.quickEntryDateInput.value = today; // Fjernet
            
            loadSettings();
            loadEntriesFromLocalStorage();
            renderEntries();
            populateTimeDropdowns(today);
            
            if (lastSelectedByggeplads) { allElements.byggepladsSelect.value = lastSelectedByggeplads; updatePlaceringOptions(); }
            if (lastSelectedPlacering && !allElements.placeringSelect.disabled) { allElements.placeringSelect.value = lastSelectedPlacering; }
            
            // Populate ferie modal dropdowns
            const currentYear = new Date().getFullYear();
            for (let i = currentYear - 1; i <= currentYear + 1; i++) {
                allElements.ferieAarSelect.add(new Option(i, i));
            }
            allElements.ferieAarSelect.value = currentYear;
            for (let i = 1; i <= 53; i++) {
                allElements.ferieUgeSelect.add(new Option(`Uge ${i}`, i));
            }

            // Event Listeners
            allElements.openSettingsModalBtn.addEventListener('click', openSettingsModal);
            allElements.closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
            allElements.settingsForm.addEventListener('submit', saveSettings);
            allElements.timeRegistrationForm.addEventListener('submit', handleFormSubmit);
            allElements.cancelEditBtn.addEventListener('click', resetFormAndEditingState);
            allElements.sendEmailBtn.addEventListener('click', openWeekSelectionModal);
            allElements.confirmWeekSelectionBtn.addEventListener('click', processAndSendEmail);
            allElements.cancelWeekSelectionBtn.addEventListener('click', closeWeekSelectionModal);
            allElements.closeWeekSelectionModalBtn.addEventListener('click', closeWeekSelectionModal);
            allElements.exportCsvBtnModal.addEventListener('click', openCsvExportModal);
            allElements.registerSickBtn.addEventListener('click', () => registerAbsence('sick'));
            allElements.registerFerieUgeBtn.addEventListener('click', openFerieUgeModal);
            allElements.confirmFerieUgeBtn.addEventListener('click', registerFerieUge);
            allElements.cancelFerieUgeBtn.addEventListener('click', closeFerieUgeModal);
            allElements.closeFerieUgeModalBtn.addEventListener('click', closeFerieUgeModal);
            allElements.byggepladsSelect.addEventListener('change', handleByggepladsChange);
            allElements.placeringSelect.addEventListener('change', (event) => { if (event.target.value === "ADD_NEW_PLACERING") { handleAddNewPlacering(); } });
            allElements.datoInput.addEventListener('change', () => populateTimeDropdowns(allElements.datoInput.value));
            allElements.startTidSelect.addEventListener('change', filterSlutTidOptions);
            allElements.employeeNameInput.addEventListener('input', (e) => { allElements.employeeInitialsInput.value = generateInitials(e.target.value); });
            allElements.imageUploadInput.addEventListener('change', (event) => { /* ... billede preview kode ... */ });

            syncPendingUploads();
            window.addEventListener('online', syncPendingUploads);
            window.addEventListener('offline', () => allElements.offlineIndicator.classList.remove('hidden'));

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registreret:', reg.scope))
                .catch(err => console.log('Service Worker registrering fejlede:', err));
            }
        });
    </script>
</body>
</html>
