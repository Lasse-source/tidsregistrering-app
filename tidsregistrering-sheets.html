<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidsregistrering (Sheets Test)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="manifest" href="manifest-sheets.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tidsreg (Test)">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png"> 
    <meta name="theme-color" content="#4f46e5">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 800px; margin: 2rem auto; padding: 2rem; background-color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); position: relative; }
        .version-number { position: absolute; bottom: 5px; right: 10px; font-size: 0.7rem; color: #9ca3af; }
        .form-input, .form-select, .form-textarea, .form-checkbox { border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; width: 100%; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25); }
        .form-checkbox { width: auto; padding: 0; margin-right: 0.5rem; margin-left:0.25rem; border-radius: 0.25rem; color: #4f46e5; }
        .form-select:disabled, .form-input:disabled { background-color: #e5e7eb; cursor: not-allowed; opacity: 0.7; }
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.15s ease-in-out; cursor: pointer; text-align: center; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #15803d; }
        .btn-info { background-color: #3b82f6; color: white; }
        .btn-info:hover:not(:disabled) { background-color: #2563eb; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        th, td { border: 1px solid #e5e7eb; padding: 0.4rem; text-align: left; font-size: 0.75rem; vertical-align: top; }
        th { background-color: #f9fafb; font-weight: 600; white-space: nowrap; }
        td .fa-pencil, td .fa-trash-can { cursor: pointer; margin-right: 8px; }
        .week-header-row, .day-header-row { cursor: pointer; user-select: none; }
        .week-header-row td, .day-header-row td { background-color: #f3f4f6; font-weight: bold; }
        .day-header-row td:first-child { padding-left: 1.5rem; } 
        .entry-row td:first-child { padding-left: 2.5rem; } 
        .toggle-icon { margin-right: 0.5em; transition: transform 0.2s; display: inline-block; }
        .toggle-icon.expanded { transform: rotate(90deg); }
        .error-message { color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; min-height: 1.25rem; }
        .quick-entry-section { background-color: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border: 1px solid #e5e7eb; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 0.5rem; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19); }
        .modal-content h3 { margin-top: 0; }
        .modal-content label { display: block; margin-bottom: 0.5rem; }
        .modal-close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .modal-close-btn:hover, .modal-close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-700">Tidsregistrering (Sheets Test)</h1>
            <button id="openSettingsModalBtn" class="btn btn-secondary px-3 py-2"><i class="fas fa-cog"></i></button>
        </div>

        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <span class="modal-close-btn" id="closeSettingsModalBtn">&times;</span>
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Indstillinger</h3>
                <form id="settingsForm" class="space-y-4">
                    <div>
                        <label for="employeeName" class="block text-sm font-medium text-gray-700">Medarbejder Navn:</label>
                        <input type="text" id="employeeName" name="employeeName" class="form-input mt-1" placeholder="Dit fulde navn" required>
                    </div>
                    <div>
                        <label for="siteLocationsSettings" class="block text-sm font-medium text-gray-700">Byggepladser & Placeringer</label>
                        <textarea id="siteLocationsSettings" name="siteLocationsSettings" rows="5" class="form-textarea mt-1" placeholder="Eksempel:&#10;Hovedkontor: Mødelokale A, Kantine&#10;Projekt Alpha: Bygning 1, Bygning 2"></textarea>
                    </div>
                    <div class="mt-6">
                         <button type="button" id="exportCsvBtnModal" class="btn btn-info w-full mb-2">Eksporter til CSV</button>
                    </div>
                     <button type="submit" class="btn btn-success w-full">Gem Indstillinger</button>
                    <div id="settingsStatus" class="text-sm mt-2"></div>
                </form>
            </div>
        </div>

        <div class="quick-entry-section">
             <h3 class="text-lg font-semibold mb-3 text-gray-600">Hurtig Registrering</h3>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div>
                     <label for="quickEntryDate" class="block text-sm font-medium text-gray-700">Vælg Dato:</label>
                     <input type="date" id="quickEntryDate" name="quickEntryDate" class="form-input mt-1" required>
                 </div>
                 <div class="flex space-x-2">
                     <button type="button" id="registerSickBtn" class="btn btn-warning w-full">Registrer Syg</button>
                     <button type="button" id="registerFreeBtn" class="btn btn-info w-full">Registrer Fri/Ferie</button>
                 </div>
                 <div id="quickEntryError" class="error-message md:col-span-3"></div>
             </div>
        </div>
        <div id="freeDayTypeModal" class="modal">
            <div class="modal-content">
                <span class="modal-close-btn" id="closeFreeDayTypeModalBtn">&times;</span>
                <h3 class="text-lg font-semibold mb-3">Vælg Type Fravær</h3>
                <div class="space-y-3">
                    <button id="registerFerieHeleDageBtn" class="btn btn-primary w-full">Ferie (Hele Dage)</button>
                    <div>
                        <label for="friTimerInput" class="block text-sm font-medium text-gray-700">Fri (Antal Timer):</label>
                        <input type="number" id="friTimerInput" min="0.5" step="0.5" class="form-input mt-1" placeholder="F.eks. 3.5">
                        <button id="registerFriTimerBtn" class="btn btn-primary w-full mt-2">Registrer Fri (Timer)</button>
                    </div>
                </div>
                <div id="freeDayTypeError" class="error-message mt-3"></div>
            </div>
        </div>

        <form id="timeRegistrationForm" class="space-y-4 mt-6">
             <h3 class="text-lg font-semibold mb-3 text-gray-600" id="formHeading">Normal Registrering</h3>
            <input type="hidden" id="editingEntryId" value="">
            <div>
                <label for="dato" class="block text-sm font-medium text-gray-700">Dato:</label>
                <input type="date" id="dato" name="dato" class="form-input mt-1" required>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="byggeplads" class="block text-sm font-medium text-gray-700">Byggeplads:</label>
                    <select id="byggeplads" name="byggeplads" class="form-select mt-1"></select>
                </div>
                 <div>
                    <label for="placering" class="block text-sm font-medium text-gray-700">Placering:</label>
                    <select id="placering" name="placering" class="form-select mt-1" disabled></select>
                </div>
            </div>
             <div>
                <label for="opgave" class="block text-sm font-medium text-gray-700">Opgave:</label>
                <input type="text" id="opgave" name="opgave" class="form-input mt-1" placeholder="F.eks. Montering af vinduer">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="startTid" class="block text-sm font-medium text-gray-700">Starttid:</label>
                    <select id="startTid" name="startTid" class="form-select mt-1" required></select>
                </div>
                <div>
                    <label for="slutTid" class="block text-sm font-medium text-gray-700">Sluttid:</label>
                    <select id="slutTid" name="slutTid" class="form-select mt-1" required></select>
                </div>
            </div>
             <div class="mt-2 space-y-2 md:space-y-0 md:flex md:items-center md:space-x-4">
                 <div class="flex items-center">
                     <input type="checkbox" id="pause9" name="pause9" class="form-checkbox h-4 w-4">
                     <label for="pause9" class="ml-1 text-sm font-medium text-gray-700">Pause kl. 9</label>
                 </div>
                 <div class="flex items-center">
                     <input type="checkbox" id="pause12" name="pause12" class="form-checkbox h-4 w-4">
                     <label for="pause12" class="ml-1 text-sm font-medium text-gray-700">Pause kl. 12</label>
                 </div>
                 <div class="flex items-center">
                     <input type="checkbox" id="ekstraarbejde" name="ekstraarbejde" class="form-checkbox h-4 w-4">
                     <label for="ekstraarbejde" class="ml-1 text-sm font-medium text-gray-700">Ekstraarbejde</label>
                 </div>
             </div>
            <div>
                <label for="materialer" class="block text-sm font-medium text-gray-700">Materialeforbrug:</label>
                <textarea id="materialer" name="materialer" rows="2" class="form-textarea mt-1"></textarea>
            </div>
            <div>
                <label for="beskrivelse" class="block text-sm font-medium text-gray-700">Bemærkninger:</label>
                <textarea id="beskrivelse" name="beskrivelse" rows="2" class="form-textarea mt-1"></textarea>
            </div>
            <div id="formError" class="error-message"></div>
            <div class="flex space-x-2">
                <button type="submit" id="submitBtn" class="btn btn-primary w-full">Tilføj Post</button>
                <button type="button" id="cancelEditBtn" class="btn btn-secondary w-full" style="display:none;">Annuller</button>
            </div>
        </form>

        <div id="statusMessage" class="mt-4"></div> 
        <div id="googleSheetStatus" class="mt-4"></div> 
        
        <h2 class="text-xl font-semibold mt-8 mb-4 text-gray-700">Registrerede Timer</h2>
        <div class="overflow-x-auto">
            <table id="entriesTable">
                <thead>
                    <tr>
                        <th>Dato</th>
                        <th>Uge</th>
                        <th>Dag</th>
                        <th>Byggeplads</th>
                        <th>Placering</th>
                        <th>Opgave</th>
                        <th>Start</th>
                        <th>Slut</th>
                        <th>Pauser</th>
                        <th>Timer</th>
                        <th>Ekstra</th>
                        <th>Materialer</th>
                        <th>Bemærk.</th>
                        <th>Handling</th>
                    </tr>
                </thead>
                <tbody id="entriesBody"></tbody>
            </table>
        </div>
        <div id="noEntriesMessage" class="text-gray-500 mt-4 text-center" style="display: none;">Ingen registreringer endnu.</div>

        <div class="mt-6 flex space-x-2">
            <button id="sendToGoogleSheetsBtn" class="btn btn-success w-full">Send til Google Sheets</button>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center">Sender alle nuværende registreringer. Sørg for at medarbejdernavn er gemt.</p>
        
        <div class="version-number">v1.3-sheets</div> 
    </div>

    <div id="csvExportModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeCsvExportModalBtn">&times;</span>
            <h3 class="text-lg font-semibold mb-3">Vælg Filtre for CSV Eksport</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Vælg Uger (alle hvis ingen valgt):</label>
                    <div id="csvWeekCheckboxesContainer" class="max-h-40 overflow-y-auto border p-2 rounded"></div>
                </div>
                <div>
                    <label for="csvByggepladsSelect" class="block text-sm font-medium text-gray-700">Vælg Byggeplads (alle hvis ingen valgt):</label>
                    <select id="csvByggepladsSelect" class="form-select mt-1">
                        <option value="">-- Alle Byggepladser --</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancelCsvExportBtn" class="btn btn-secondary">Annuller</button>
                <button id="confirmCsvExportBtn" class="btn btn-primary">Eksporter CSV</button>
            </div>
             <div id="csvExportStatus" class="text-sm mt-2"></div>
        </div>
    </div>
    
    <script>
        // --- Globale Variabler ---
        const settingsModal = document.getElementById('settingsModal');
        const openSettingsModalBtn = document.getElementById('openSettingsModalBtn');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
        const settingsForm = document.getElementById('settingsForm');
        const timeRegistrationForm = document.getElementById('timeRegistrationForm');
        const formHeading = document.getElementById('formHeading');
        const editingEntryIdInput = document.getElementById('editingEntryId');
        const submitBtn = document.getElementById('submitBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const startTidSelect = document.getElementById('startTid');
        const slutTidSelect = document.getElementById('slutTid');
        const entriesBody = document.getElementById('entriesBody');
        const formError = document.getElementById('formError');
        const settingsStatus = document.getElementById('settingsStatus');
        const statusMessage = document.getElementById('statusMessage');
        const googleSheetStatus = document.getElementById('googleSheetStatus');
        const noEntriesMessage = document.getElementById('noEntriesMessage');
        const entriesTable = document.getElementById('entriesTable');
        const sendToGoogleSheetsBtn = document.getElementById('sendToGoogleSheetsBtn');
        const exportCsvBtnModal = document.getElementById('exportCsvBtnModal');
        const csvExportModal = document.getElementById('csvExportModal');
        const closeCsvExportModalBtn = document.getElementById('closeCsvExportModalBtn');
        const csvWeekCheckboxesContainer = document.getElementById('csvWeekCheckboxesContainer');
        const csvByggepladsSelect = document.getElementById('csvByggepladsSelect');
        const cancelCsvExportBtn = document.getElementById('cancelCsvExportBtn');
        const confirmCsvExportBtn = document.getElementById('confirmCsvExportBtn');
        const csvExportStatus = document.getElementById('csvExportStatus');
        const quickEntryDateInput = document.getElementById('quickEntryDate');
        const registerSickBtn = document.getElementById('registerSickBtn');
        const registerFreeBtn = document.getElementById('registerFreeBtn');
        const quickEntryError = document.getElementById('quickEntryError');
        const freeDayTypeModal = document.getElementById('freeDayTypeModal');
        const closeFreeDayTypeModalBtn = document.getElementById('closeFreeDayTypeModalBtn');
        const registerFerieHeleDageBtn = document.getElementById('registerFerieHeleDageBtn');
        const friTimerInput = document.getElementById('friTimerInput');
        const registerFriTimerBtn = document.getElementById('registerFriTimerBtn');
        const freeDayTypeError = document.getElementById('freeDayTypeError');
        const employeeNameInput = document.getElementById('employeeName');
        const siteLocationsSettingsTextarea = document.getElementById('siteLocationsSettings');
        const datoInput = document.getElementById('dato');
        const byggepladsSelect = document.getElementById('byggeplads');
        const placeringSelect = document.getElementById('placering');
        const opgaveInput = document.getElementById('opgave');
        const pause9Checkbox = document.getElementById('pause9');
        const pause12Checkbox = document.getElementById('pause12');
        const ekstraarbejdeCheckbox = document.getElementById('ekstraarbejde');
        const materialerInput = document.getElementById('materialer');
        const beskrivelseInput = document.getElementById('beskrivelse');

        let weeklyEntries = [];
        let settings = { siteLocations: [] };
        const standardByggepladsOptionsForForm = ["Andet"];
        let lastSelectedByggeplads = '';
        let lastSelectedPlacering = '';
        let currentlyEditingId = null;

        const SCRIPT_URL = "ERSTAT_MED_DIN_GOOGLE_APPS_SCRIPT_WEB_APP_URL";
        
        // --- ALLE JAVASCRIPT FUNKTIONER ER NU INDSAT HERUNDER ---
        function getTodayString() { return new Date().toISOString().split('T')[0]; }
        function getISODateString(date) { return date.toISOString().split('T')[0]; }

        function parseSiteLocations(text) {
            const lines = text.trim().split('\n');
            const siteData = [];
            lines.forEach(line => {
                const parts = line.split(':');
                const siteName = parts[0]?.trim();
                if (siteName) {
                    const locationsRaw = parts[1]?.trim() || '';
                    const locations = locationsRaw ? locationsRaw.split(',').map(loc => loc.trim()).filter(loc => loc) : [];
                    siteData.push({ site: siteName, locations: locations });
                }
            });
            return siteData;
        }

        function saveSettings(event) {
            event.preventDefault();
            const rawSiteLocationsText = siteLocationsSettingsTextarea.value;
            settings = {
                employeeName: employeeNameInput.value.trim(),
                siteLocationsRaw: rawSiteLocationsText,
                siteLocations: parseSiteLocations(rawSiteLocationsText)
            };
            if (!settings.employeeName) {
                settingsStatus.textContent = 'Udfyld venligst medarbejdernavn.';
                settingsStatus.className = 'text-sm mt-2 text-red-600';
                return;
            }
            localStorage.setItem('timeRegSettings', JSON.stringify(settings));
            settingsStatus.textContent = 'Indstillinger gemt!';
            settingsStatus.className = 'text-sm mt-2 text-green-600';
            setTimeout(() => { settingsStatus.textContent = ''; }, 3000);
            populateByggepladsDropdown();
            updateGoogleSheetsButtonStatus();
            closeSettingsModal();
        }

        function loadSettings() {
            const storedSettings = localStorage.getItem('timeRegSettings');
            if (storedSettings) {
                settings = JSON.parse(storedSettings);
                settings.employeeName = settings.employeeName || '';
                settings.siteLocationsRaw = settings.siteLocationsRaw || '';
                settings.siteLocations = parseSiteLocations(settings.siteLocationsRaw);
                employeeNameInput.value = settings.employeeName;
                siteLocationsSettingsTextarea.value = settings.siteLocationsRaw;
            } else {
                settings = { employeeName: '', siteLocationsRaw: '', siteLocations: [] };
            }
        }
        
        function updateGoogleSheetsButtonStatus() {
            sendToGoogleSheetsBtn.disabled = !settings.employeeName;
            googleSheetStatus.textContent = sendToGoogleSheetsBtn.disabled ? 'Udfyld og gem medarbejdernavn i indstillinger for at sende.' : '';
        }

        function openSettingsModal() { settingsModal.style.display = 'flex'; }
        function closeSettingsModal() { settingsModal.style.display = 'none'; }
        
        function openFreeDayTypeModal() {
            freeDayTypeError.textContent = '';
            friTimerInput.value = '';
            freeDayTypeModal.style.display = 'flex';
        }
        function closeFreeDayTypeModal() { freeDayTypeModal.style.display = 'none'; }

        function populateTimeDropdowns(selectedDate) {
            const interval = 30;
            startTidSelect.innerHTML = '';
            slutTidSelect.innerHTML = '';

            const dayEntries = weeklyEntries.filter(entry => entry.dato === selectedDate && entry.id !== currentlyEditingId && entry.startTid && entry.slutTid);
            const bookedSlots = dayEntries.map(entry => ({
                start: timeToMinutes(entry.startTid),
                end: timeToMinutes(entry.slutTid)
            }));

            for (let minutes = 6 * 60; minutes <= 17 * 60; minutes += interval) {
                const slotStart = minutes;
                const slotEnd = minutes + interval;
                let isSlotBooked = false;

                for (const booked of bookedSlots) {
                    if (slotStart < booked.end && slotEnd > booked.start) {
                        isSlotBooked = true;
                        break;
                    }
                }
                
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                const timeString = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
                
                const optionStart = document.createElement('option');
                optionStart.value = timeString;
                
                if (isSlotBooked) {
                    optionStart.textContent = `${timeString} (Optaget)`;
                    optionStart.style.color = 'red';
                } else {
                    optionStart.textContent = timeString;
                    optionStart.style.color = 'green';
                }
                startTidSelect.appendChild(optionStart);
            }
            filterSlutTidOptions();
        }
        
        function filterSlutTidOptions() {
            const selectedStartTid = startTidSelect.value.replace(" (Optaget)", "");
            const selectedDate = datoInput.value;
            slutTidSelect.innerHTML = '';

            if (!selectedStartTid || !selectedDate) return;

            const startMinutes = timeToMinutes(selectedStartTid);
            const interval = 30;

            const dayEntries = weeklyEntries.filter(entry => entry.dato === selectedDate && entry.id !== currentlyEditingId && entry.startTid && entry.slutTid);
            const bookedSlots = dayEntries.map(entry => ({
                start: timeToMinutes(entry.startTid),
                end: timeToMinutes(entry.slutTid)
            }));

            for (let minutes = startMinutes + interval; minutes <= 17 * 60 + interval ; minutes += interval) {
                if (minutes > (17*60 + 30)) continue;

                const currentIntervalStart = startMinutes;
                const currentIntervalEnd = minutes;
                let isPathToThisEndBooked = false;

                for (const booked of bookedSlots) {
                    if (booked.start > startMinutes && booked.start < currentIntervalEnd) {
                        isPathToThisEndBooked = true;
                        break;
                    }
                }
                
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                const timeString = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
                const option = document.createElement('option');
                option.value = timeString;
                option.textContent = timeString;

                if (isPathToThisEndBooked) {
                    option.textContent = `${timeString} (Blokeret)`;
                    option.style.color = 'red';
                    option.disabled = true;
                } else {
                    option.style.color = 'green';
                }
                slutTidSelect.appendChild(option);
            }
            if (slutTidSelect.options.length === 0 && selectedStartTid) {
                const option = document.createElement('option');
                option.textContent = "-- Ingen ledige sluttider --";
                option.disabled = true;
                slutTidSelect.appendChild(option);
            }
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getDayName(dateString, locale = 'da-DK') {
            const date = new Date(dateString + 'T12:00:00');
            return date.toLocaleDateString(locale, { weekday: 'long' });
        }

        function getDayOfWeek(dateString) {
            const date = new Date(dateString + 'T12:00:00');
            return (date.getDay() + 6) % 7;
        }

        function timeToMinutes(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function calculateDuration(startStr, endStr, pause9, pause12) {
            if (!startStr || !endStr) return 0;
            const cleanStartStr = startStr.replace(" (Optaget)", "");
            const cleanEndStr = endStr.replace(/ \(Optaget\)|\(Blokeret\)/g, "");
            const startMinutes = timeToMinutes(cleanStartStr);
            const endMinutes = timeToMinutes(cleanEndStr);
            if (endMinutes <= startMinutes) return 0;
            let grossDurationMinutes = endMinutes - startMinutes;
            let pauseDurationMinutes = 0;
            if (pause9) {
                const pause9Start = 9 * 60;
                const pause9End = 9 * 60 + 30;
                if (startMinutes < pause9End && endMinutes > pause9Start) {
                    pauseDurationMinutes += 30;
                }
            }
            if (pause12) {
                const pause12Start = 12 * 60;
                const pause12End = 12 * 60 + 30;
                if (startMinutes < pause12End && endMinutes > pause12Start) {
                    pauseDurationMinutes += 30;
                }
            }
            const netDurationMinutes = grossDurationMinutes - pauseDurationMinutes;
            return netDurationMinutes > 0 ? netDurationMinutes / 60 : 0;
        }

        function populateByggepladsDropdown() {
            const currentValue = byggepladsSelect.value;
            byggepladsSelect.innerHTML = '<option value="">-- Vælg Byggeplads --</option>';
            settings.siteLocations.forEach(siteInfo => {
                const option = document.createElement('option');
                option.value = siteInfo.site; option.textContent = siteInfo.site;
                byggepladsSelect.appendChild(option);
            });
            standardByggepladsOptionsForForm.forEach(stdOption => {
                const option = document.createElement('option');
                option.value = stdOption; option.textContent = stdOption;
                byggepladsSelect.appendChild(option);
            });
            const addNewOption = document.createElement('option');
            addNewOption.value = "ADD_NEW_SITE";
            addNewOption.textContent = "Tilføj ny byggeplads...";
            byggepladsSelect.appendChild(addNewOption);
            if (currentValue && Array.from(byggepladsSelect.options).some(opt => opt.value === currentValue)) {
                byggepladsSelect.value = currentValue;
            }
            updatePlaceringOptions();
        }

        function updatePlaceringOptions() {
            const selectedSiteName = byggepladsSelect.value;
            const currentPlaceringValue = placeringSelect.value;
            placeringSelect.innerHTML = '';
            placeringSelect.disabled = true;
            if (!selectedSiteName || selectedSiteName === "ADD_NEW_SITE" || standardByggepladsOptionsForForm.includes(selectedSiteName)) {
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = (selectedSiteName && selectedSiteName !== "ADD_NEW_SITE") ? '-- Ikke relevant --' : '-- Vælg Byggeplads Først --';
                placeringSelect.appendChild(defaultOption);
                return;
            }
            const siteInfo = settings.siteLocations.find(s => s.site === selectedSiteName);
            placeringSelect.disabled = false;
            const defaultSelectOption = document.createElement('option');
            defaultSelectOption.value = "";
            defaultSelectOption.textContent = "-- Vælg Placering --";
            placeringSelect.appendChild(defaultSelectOption);
            if (siteInfo && siteInfo.locations.length > 0) {
                siteInfo.locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    placeringSelect.appendChild(option);
                });
            }
            const addNewPlaceringOption = document.createElement('option');
            addNewPlaceringOption.value = "ADD_NEW_PLACERING";
            addNewPlaceringOption.textContent = "Tilføj ny placering...";
            placeringSelect.appendChild(addNewPlaceringOption);
            if (currentPlaceringValue && Array.from(placeringSelect.options).some(opt => opt.value === currentPlaceringValue)) {
                placeringSelect.value = currentPlaceringValue;
            }
        }

        function handleAddNewSite() {
            const newSiteName = prompt("Indtast navn på ny byggeplads:");
            if (newSiteName && newSiteName.trim() !== "") {
                const trimmedName = newSiteName.trim();
                if (!settings.siteLocations.find(s => s.site.toLowerCase() === trimmedName.toLowerCase())) {
                    settings.siteLocations.unshift({ site: trimmedName, locations: [] });
                    settings.siteLocationsRaw = formatSiteLocations(settings.siteLocations);
                    siteLocationsSettingsTextarea.value = settings.siteLocationsRaw;
                    localStorage.setItem('timeRegSettings', JSON.stringify(settings));
                    populateByggepladsDropdown();
                    byggepladsSelect.value = trimmedName;
                    updatePlaceringOptions();
                } else {
                    alert("Denne byggeplads findes allerede.");
                    byggepladsSelect.value = trimmedName;
                }
            } else {
                byggepladsSelect.value = "";
            }
        }

        function formatSiteLocations(siteData) {
            return siteData.map(item => `${item.site}: ${item.locations.join(', ')}`).join('\n');
        }

        function handleAddNewPlacering() {
            const selectedSiteName = byggepladsSelect.value;
            if (!selectedSiteName || selectedSiteName === "ADD_NEW_SITE" || standardByggepladsOptionsForForm.includes(selectedSiteName)) {
                alert("Vælg venligst en gyldig byggeplads først.");
                placeringSelect.value = "";
                return;
            }
            const newPlaceringName = prompt(`Indtast navn på ny placering for "${selectedSiteName}":`);
            if (newPlaceringName && newPlaceringName.trim() !== "") {
                const trimmedPlacering = newPlaceringName.trim();
                const siteInfo = settings.siteLocations.find(s => s.site === selectedSiteName);
                if (siteInfo) {
                    if (!siteInfo.locations.find(loc => loc.toLowerCase() === trimmedPlacering.toLowerCase())) {
                        siteInfo.locations.unshift(trimmedPlacering);
                        settings.siteLocationsRaw = formatSiteLocations(settings.siteLocations);
                        siteLocationsSettingsTextarea.value = settings.siteLocationsRaw;
                        localStorage.setItem('timeRegSettings', JSON.stringify(settings));
                        updatePlaceringOptions();
                        placeringSelect.value = trimmedPlacering;
                    } else {
                        alert("Denne placering findes allerede for den valgte byggeplads.");
                        placeringSelect.value = trimmedPlacering;
                    }
                }
            } else {
                placeringSelect.value = "";
            }
        }

        function showStatusMessage(message, type = 'success', element = statusMessage) {
            element.textContent = message;
            element.className = `my-2 p-3 rounded-md text-sm ${type === 'success' ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-red-100 text-red-700 border border-red-300'}`;
            setTimeout(() => {
                if (element.textContent === message) {
                    element.textContent = '';
                    element.className = element === quickEntryError ? 'error-message md:col-span-3' : (element === googleSheetStatus ? 'mt-4' : 'mt-4');
                }
            }, 5000);
        }

        function toggleNoEntriesMessage() {
            noEntriesMessage.style.display = weeklyEntries.length === 0 ? 'block' : 'none';
            entriesTable.style.display = weeklyEntries.length === 0 ? 'none' : 'table';
        }

        function renderEntries() {
            entriesBody.innerHTML = '';
            if (weeklyEntries.length === 0) {
                toggleNoEntriesMessage();
                return;
            }
            const entriesByWeek = weeklyEntries.reduce((acc, entry) => {
                (acc[entry.uge] = acc[entry.uge] || []).push(entry);
                return acc;
            }, {});
            const sortedWeeks = Object.keys(entriesByWeek).sort((a, b) => parseInt(a) - parseInt(b));
            sortedWeeks.forEach(weekKey => {
                const weekEntries = entriesByWeek[weekKey];
                let weeklyTotalHours = 0;
                weekEntries.forEach(e => weeklyTotalHours += e.timer);
                const weekHeaderRow = entriesBody.insertRow();
                weekHeaderRow.classList.add('week-header-row');
                weekHeaderRow.dataset.week = weekKey;
                let cell = weekHeaderRow.insertCell();
                cell.innerHTML = `<i class="fas fa-caret-right toggle-icon"></i> Uge ${weekKey} (${weeklyTotalHours.toFixed(2)} timer)`;
                cell.colSpan = entriesTable.tHead.rows[0].cells.length;
                cell.addEventListener('click', () => toggleWeekVisibility(weekKey));
                const entriesByDay = weekEntries.reduce((acc, entry) => {
                    (acc[entry.dato] = acc[entry.dato] || []).push(entry);
                    return acc;
                }, {});
                const sortedDaysInWeek = Object.keys(entriesByDay).sort((a,b) => new Date(a) - new Date(b));
                sortedDaysInWeek.forEach(dateKey => {
                    const dayEntries = entriesByDay[dateKey];
                    let dailyTotalHours = 0;
                    dayEntries.forEach(e => dailyTotalHours += e.timer);
                    const dayHeaderRow = entriesBody.insertRow();
                    dayHeaderRow.classList.add('day-header-row', `week-detail-${weekKey}`);
                    dayHeaderRow.style.display = 'none';
                    dayHeaderRow.dataset.date = dateKey;
                    dayHeaderRow.dataset.parentWeek = weekKey;
                    let dayCell1 = dayHeaderRow.insertCell();
                    dayCell1.innerHTML = "&nbsp;";
                    let dayCell2 = dayHeaderRow.insertCell();
                    dayCell2.innerHTML = `<i class="fas fa-caret-right toggle-icon"></i> ${getDayName(dateKey)} (${dailyTotalHours.toFixed(2)} timer)`;
                    dayCell2.colSpan = entriesTable.tHead.rows[0].cells.length -1;
                    dayCell2.addEventListener('click', (e) => { e.stopPropagation(); toggleDayVisibility(dateKey, weekKey); });
                    dayEntries.sort((a,b) => timeToMinutes(a.startTid) - timeToMinutes(b.startTid)).forEach((entry) => {
                        const row = entriesBody.insertRow();
                        row.classList.add('entry-row', `week-detail-${weekKey}`, `day-detail-${dateKey}`);
                        row.style.display = 'none';
                        let pauseText = "";
                        if (entry.pause9 && entry.pause12) pauseText = "60m";
                        else if (entry.pause9 || entry.pause12) pauseText = "30m";
                        else pauseText = "0m";
                        row.insertCell().textContent = new Date(entry.dato + 'T12:00:00').toLocaleDateString('da-DK', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        row.insertCell().textContent = entry.uge;
                        row.insertCell().textContent = entry.dag;
                        row.insertCell().textContent = entry.byggeplads;
                        row.insertCell().textContent = entry.placering || '-';
                        row.insertCell().textContent = entry.opgave;
                        row.insertCell().textContent = entry.startTid || '-';
                        row.insertCell().textContent = entry.slutTid || '-';
                        row.insertCell().textContent = pauseText;
                        row.insertCell().textContent = entry.timer.toFixed(2);
                        row.insertCell().textContent = entry.ekstraarbejde ? 'Ja' : 'Nej';
                        const materialerCell = row.insertCell();
                        materialerCell.textContent = entry.materialer && entry.materialer.length > 10 ? entry.materialer.substring(0, 10) + '...' : entry.materialer;
                        if (entry.materialer && entry.materialer.length > 10) materialerCell.title = entry.materialer;
                        const beskrivelseCell = row.insertCell();
                        beskrivelseCell.textContent = entry.beskrivelse.length > 10 ? entry.beskrivelse.substring(0, 10) + '...' : entry.beskrivelse;
                        if (entry.beskrivelse.length > 10) { beskrivelseCell.title = entry.beskrivelse; }
                        const actionsCell = row.insertCell();
                        const editButton = document.createElement('i');
                        editButton.classList.add('fas', 'fa-pencil', 'text-blue-600', 'hover:text-blue-800');
                        editButton.onclick = (e) => { e.stopPropagation(); loadEntryForEdit(entry.id);};
                        actionsCell.appendChild(editButton);
                        const deleteButton = document.createElement('i');
                        deleteButton.classList.add('fas', 'fa-trash-can', 'text-red-600', 'hover:text-red-800');
                        deleteButton.onclick = (e) => { e.stopPropagation(); deleteEntry(entry.id);};
                        actionsCell.appendChild(deleteButton);
                    });
                });
            });
            saveEntriesToLocalStorage();
            toggleNoEntriesMessage();
        }

        function toggleWeekVisibility(weekKey) {
            const weekRows = document.querySelectorAll(`.week-detail-${weekKey}`);
            const icon = document.querySelector(`.week-header-row[data-week="${weekKey}"] .toggle-icon`);
            const isHidden = weekRows[0] && weekRows[0].style.display === 'none';
            weekRows.forEach(row => {
                if (row.classList.contains('day-header-row')) {
                    row.style.display = isHidden ? 'table-row' : 'none';
                }
                if (!isHidden && row.classList.contains('entry-row')) { row.style.display = 'none'; }
                if(!isHidden && row.classList.contains('day-header-row')){
                    const dayIcon = row.querySelector('.toggle-icon');
                    if(dayIcon) dayIcon.classList.remove('expanded');
                }
            });
            if (icon) icon.classList.toggle('expanded', isHidden);
        }

        function toggleDayVisibility(dateKey, weekKey) {
            const dayRows = document.querySelectorAll(`.day-detail-${dateKey}.week-detail-${weekKey}`);
            const icon = document.querySelector(`.day-header-row[data-date="${dateKey}"] .toggle-icon`);
            const isHidden = dayRows[0] && dayRows[0].style.display === 'none';
            dayRows.forEach(row => { row.style.display = isHidden ? 'table-row' : 'none'; });
            if (icon) icon.classList.toggle('expanded', isHidden);
        }

        function createEntryObject(formData) {
            const entryDate = new Date(formData.dato + 'T12:00:00');
            const timerToUse = (typeof formData.timer === 'number' && formData.timer !== -1) ? formData.timer : calculateDuration(formData.startTid, formData.slutTid, formData.pause9, formData.pause12);
            return {
                id: formData.id || Date.now() + Math.random(),
                dato: formData.dato, uge: getWeekNumber(entryDate), dag: getDayName(formData.dato),
                byggeplads: formData.byggeplads || '', placering: formData.placering || '',
                opgave: formData.opgave || '',
                startTid: formData.startTid ? formData.startTid.replace(" (Optaget)", "") : null,
                slutTid: formData.slutTid ? formData.slutTid.replace(/ \(Optaget\)|\(Blokeret\)/g, "") : null,
                pause9: formData.pause9 || false, pause12: formData.pause12 || false,
                timer: timerToUse, ekstraarbejde: formData.ekstraarbejde || false,
                materialer: formData.materialer || '', beskrivelse: formData.beskrivelse || ''
            };
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            formError.textContent = '';
            const startTidValue = startTidSelect.value.replace(" (Optaget)", "");
            const slutTidValue = slutTidSelect.value.replace(/ \(Optaget\)|\(Blokeret\)/g, "");
            const dato = datoInput.value;
            const byggeplads = byggepladsSelect.value;
            const placering = placeringSelect.disabled ? '' : placeringSelect.value;
            if (!dato) { formError.textContent = 'Vælg venligst en dato.'; return; }
            if (!byggeplads || byggeplads === "ADD_NEW_SITE") { formError.textContent = 'Vælg venligst en byggeplads.'; return; }
            if (standardByggepladsOptionsForForm.includes(byggeplads) && (byggeplads === "Syg" || byggeplads === "Fri" || byggeplads === "Ferie")) { formError.textContent = `Brug knapperne under "Hurtig Registrering" for ${byggeplads}.`; return; }
            if (!startTidValue || !slutTidValue) { formError.textContent = 'Udfyld venligst starttid og sluttid.'; return; }
            if (!placeringSelect.disabled && (!placering || placering === "ADD_NEW_PLACERING")) { formError.textContent = 'Vælg venligst en placering for den valgte byggeplads.'; return; }
            const calculatedTimer = calculateDuration(startTidValue, slutTidValue, pause9Checkbox.checked, pause12Checkbox.checked);
            if (timeToMinutes(slutTidValue) <= timeToMinutes(startTidValue)) { formError.textContent = 'Sluttid skal være efter starttid.'; return; }
            const dayEntries = weeklyEntries.filter(entry => entry.dato === dato && entry.id !== currentlyEditingId && entry.startTid && entry.slutTid);
            const startMinutes = timeToMinutes(startTidValue);
            const endMinutes = timeToMinutes(slutTidValue);
            for (const booked of dayEntries.map(e => ({start: timeToMinutes(e.startTid), end: timeToMinutes(e.slutTid)}))) {
                if (startMinutes < booked.end && endMinutes > booked.start) { formError.textContent = 'Den valgte tid overlapper med en eksisterende registrering.'; return; }
            }
            const entryData = { id: currentlyEditingId, dato: dato, byggeplads: byggeplads, placering: placering === "Andet (specificer)" ? "Andet (specificer)" : placering, opgave: opgaveInput.value.trim(), startTid: startTidValue, slutTid: slutTidValue, pause9: pause9Checkbox.checked, pause12: pause12Checkbox.checked, timer: calculatedTimer, ekstraarbejde: ekstraarbejdeCheckbox.checked, materialer: materialerInput.value.trim(), beskrivelse: beskrivelseInput.value.trim() };
            const newOrUpdatedEntry = createEntryObject(entryData);
            if (currentlyEditingId) {
                const index = weeklyEntries.findIndex(e => e.id === currentlyEditingId);
                if (index > -1) { weeklyEntries[index] = newOrUpdatedEntry; }
                showStatusMessage('Post opdateret succesfuldt!');
            } else {
                weeklyEntries.push(newOrUpdatedEntry);
                showStatusMessage('Post tilføjet succesfuldt!');
            }
            lastSelectedByggeplads = byggeplads;
            lastSelectedPlacering = placeringSelect.disabled ? '' : placering;
            resetFormAndEditingState();
            renderEntries();
        }

        function loadEntryForEdit(entryId) {
            const entry = weeklyEntries.find(e => e.id === entryId);
            if (!entry) return;
            currentlyEditingId = entryId;
            formHeading.textContent = "Rediger Registrering";
            submitBtn.textContent = "Gem Ændringer";
            cancelEditBtn.style.display = 'inline-block';
            datoInput.value = entry.dato;
            byggepladsSelect.value = entry.byggeplads;
            updatePlaceringOptions();
            placeringSelect.value = entry.placering || "";
            opgaveInput.value = entry.opgave;
            populateTimeDropdowns(entry.dato);
            if (entry.startTid) {
                let cleanStartTime = entry.startTid.replace(" (Optaget)", "");
                let startOptionExists = Array.from(startTidSelect.options).some(opt => opt.value === cleanStartTime || opt.value === entry.startTid);
                if (!startOptionExists) {
                    const opt = document.createElement('option'); opt.value = cleanStartTime; opt.textContent = cleanStartTime;
                    startTidSelect.insertBefore(opt, startTidSelect.firstChild);
                }
                startTidSelect.value = cleanStartTime;
            }
            filterSlutTidOptions();
            if (entry.slutTid) {
                let cleanEndTime = entry.slutTid.replace(/ \(Optaget\)|\(Blokeret\)/g, "");
                let endOptionExists = Array.from(slutTidSelect.options).some(opt => opt.value === cleanEndTime || opt.value === entry.slutTid);
                if(!endOptionExists){
                    const opt = document.createElement('option'); opt.value = cleanEndTime; opt.textContent = cleanEndTime;
                    slutTidSelect.insertBefore(opt, slutTidSelect.firstChild);
                }
                slutTidSelect.value = cleanEndTime;
            }
            pause9Checkbox.checked = entry.pause9 || false;
            pause12Checkbox.checked = entry.pause12 || false;
            ekstraarbejdeCheckbox.checked = entry.ekstraarbejde || false;
            materialerInput.value = entry.materialer || '';
            beskrivelseInput.value = entry.beskrivelse || '';
            window.scrollTo({ top: timeRegistrationForm.offsetTop - 20, behavior: 'smooth' });
        }

        function resetFormAndEditingState() {
            timeRegistrationForm.reset();
            currentlyEditingId = null;
            formHeading.textContent = "Normal Registrering";
            submitBtn.textContent = "Tilføj Post";
            cancelEditBtn.style.display = 'none';
            datoInput.value = getTodayString();
            if (lastSelectedByggeplads) { byggepladsSelect.value = lastSelectedByggeplads; }
            else { byggepladsSelect.value = ""; }
            updatePlaceringOptions();
            if (lastSelectedPlacering && !placeringSelect.disabled) { placeringSelect.value = lastSelectedPlacering; }
            else { placeringSelect.value = ""; }
            populateTimeDropdowns(datoInput.value);
        }

        function registerAbsence(type, hours = null) {
            quickEntryError.textContent = '';
            freeDayTypeError.textContent = '';
            const dato = quickEntryDateInput.value;
            if (!dato) { showStatusMessage('Vælg venligst en dato for fravær.', 'error', quickEntryError); return; }
            const dayOfWeek = getDayOfWeek(dato);
            if (dayOfWeek >= 5 && (type === 'sick' || type === 'ferie-hele-dage')) { showStatusMessage('Syg/Ferie kan kun registreres på hverdage (man-fre).', 'error', quickEntryError); return; }
            let timerValue;
            let description;
            let byggepladsVal;
            if (type === 'sick') {
                timerValue = (dayOfWeek === 4) ? 5 : 8;
                description = "Syg";
                byggepladsVal = "Syg";
            } else if (type === 'ferie-hele-dage') {
                timerValue = (dayOfWeek === 4) ? 5 : 8;
                description = "Ferie (Hele dage)";
                byggepladsVal = "Ferie";
            } else if (type === 'fri-timer') {
                if (hours === null || isNaN(parseFloat(hours)) || parseFloat(hours) <= 0) { showStatusMessage('Indtast venligst et gyldigt antal timer for "Fri (timer)".', 'error', freeDayTypeError); return; }
                timerValue = parseFloat(hours);
                description = `Fri (${timerValue} timer)`;
                byggepladsVal = "Fri";
            } else { return; }
            const entryData = createEntryObject({ dato: dato, byggeplads: byggepladsVal, placering: '-', opgave: description, startTid: null, slutTid: null, timer: timerValue, pause9: false, pause12: false, ekstraarbejde: false, beskrivelse: description, materialer: '' });
            weeklyEntries.push(entryData);
            renderEntries();
            populateTimeDropdowns(datoInput.value);
            showStatusMessage(`${description} registreret for ${new Date(dato + 'T12:00:00').toLocaleDateString('da-DK')}.`);
            closeFreeDayTypeModal();
        }

        function deleteEntry(entryId) {
            if (confirm('Er du sikker på, du vil slette denne post?')) {
                const entryDate = weeklyEntries.find(e => e.id === entryId)?.dato;
                weeklyEntries = weeklyEntries.filter(entry => entry.id !== entryId);
                if (currentlyEditingId === entryId) { resetFormAndEditingState(); }
                renderEntries();
                if (entryDate === datoInput.value || datoInput.value === getTodayString()) { populateTimeDropdowns(datoInput.value); }
                showStatusMessage('Post slettet.', 'error');
            }
        }

        function saveEntriesToLocalStorage() {
            localStorage.setItem('weeklyTimeEntries', JSON.stringify(weeklyEntries));
        }

        function loadEntriesFromLocalStorage() {
            const storedEntries = localStorage.getItem('weeklyTimeEntries');
            if (storedEntries) {
                weeklyEntries = JSON.parse(storedEntries);
                weeklyEntries.forEach(entry => {
                    entry.id = entry.id || Date.now() + Math.random();
                    entry.timer = parseFloat(entry.timer) || 0;
                    entry.ekstraarbejde = !!entry.ekstraarbejde;
                    entry.pause9 = !!entry.pause9;
                    entry.pause12 = !!entry.pause12;
                    entry.materialer = entry.materialer || '';
                });
            } else {
                loadTestDataIfEmpty(); // Load test data if nothing is in storage
            }
        }

        function loadTestDataIfEmpty() {
            if (weeklyEntries.length > 0) return; // Don't load if there's already data
            console.log("Ingen gemte data fundet. Indlæser testdata for en fiktiv uge.");
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(monday.getDate() - (today.getDay() + 6) % 7);

            const testEntriesRaw = [
                { dato: getISODateString(monday), byggeplads: "Projekt Alpha", placering: "Bygning 1", opgave: "Opsætning af vægge", startTid: "07:00", slutTid: "15:00", pause9: true, pause12: true, ekstraarbejde: false, materialer: "20 gipsplader, 500 skruer", beskrivelse: "" },
                { dato: getISODateString(new Date(monday).setDate(monday.getDate() + 1)), byggeplads: "Hovedkontor", placering: "Mødelokale A", opgave: "Maling af loft", startTid: "08:00", slutTid: "16:00", pause9: true, pause12: true, ekstraarbejde: false, materialer: "10L hvid maling", beskrivelse: "To lag" },
                { dato: getISODateString(new Date(monday).setDate(monday.getDate() + 2)), byggeplads: "Projekt Alpha", placering: "Bygning 2 - Etage 3", opgave: "Installation af el", startTid: "07:30", slutTid: "12:00", pause9: true, pause12: false, ekstraarbejde: true, materialer: "50m kabel", beskrivelse: "" },
                { dato: getISODateString(new Date(monday).setDate(monday.getDate() + 2)), byggeplads: "Værksted", placering: "-", opgave: "Klargøring af materialer", startTid: "12:30", slutTid: "16:00", pause9: false, pause12: false, ekstraarbejde: false, materialer: "", beskrivelse: "" },
                { dato: getISODateString(new Date(monday).setDate(monday.getDate() + 3)), byggeplads: "Syg", placering: "-", opgave: "Syg", timer: 8 },
                { dato: getISODateString(new Date(monday).setDate(monday.getDate() + 4)), byggeplads: "Projekt Alpha", placering: "Bygning 1", opgave: "Færdiggørelse af vægge", startTid: "07:00", slutTid: "12:00", pause9: true, pause12: false, ekstraarbejde: false, materialer: "", beskrivelse: "Klar til spartling" },
            ];
            
            testEntriesRaw.forEach(entry => {
                const newEntry = createEntryObject(entry);
                if (entry.timer) newEntry.timer = entry.timer; // Preserve special hours for Syg/Fri
                weeklyEntries.push(newEntry);
            });
            saveEntriesToLocalStorage(); 
        }

        async function sendDataToGoogleSheets() {
            googleSheetStatus.textContent = '';
            if (!settings.employeeName) {
                showStatusMessage('Udfyld og gem medarbejdernavn i indstillinger først.', 'error', googleSheetStatus);
                openSettingsModal();
                return;
            }
            if (weeklyEntries.length === 0) {
                showStatusMessage('Ingen registreringer at sende.', 'error', googleSheetStatus);
                return;
            }
            if (SCRIPT_URL.includes("ERSTAT_MED_DIN")) {
                showStatusMessage("Google Apps Script URL er ikke konfigureret korrekt.", "error", googleSheetStatus);
                return;
            }

            sendToGoogleSheetsBtn.disabled = true;
            sendToGoogleSheetsBtn.textContent = "Sender...";

            const dataToSend = weeklyEntries.map(entry => ({
                medarbejderNavn: settings.employeeName,
                dato: entry.dato, uge: entry.uge, dag: entry.dag,
                byggeplads: entry.byggeplads, placering: entry.placering || '-',
                opgave: entry.opgave || '-', startTid: entry.startTid || '-',
                slutTid: entry.slutTid || '-', pause9: entry.pause9 ? "Ja" : "Nej",
                pause12: entry.pause12 ? "Ja" : "Nej", timer: entry.timer.toFixed(2),
                ekstraarbejde: entry.ekstraarbejde ? "Ja" : "Nej",
                materialer: entry.materialer || '-', beskrivelse: entry.beskrivelse || '-'
            }));

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify({ entries: dataToSend }),
                    headers: { 'Content-Type': 'application/json' }
                });

                const responseDataText = await response.text();
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status} - ${responseDataText}`); }

                const result = JSON.parse(responseDataText);
                if(result.status === 'success') {
                    showStatusMessage('Data sendt succesfuldt til Google Sheets!', 'success', googleSheetStatus);
                    if (confirm("Data er sendt. Vil du rydde listen med registreringer?")) {
                        weeklyEntries = [];
                        saveEntriesToLocalStorage();
                        renderEntries();
                    }
                } else {
                    throw new Error(result.message || 'Ukendt fejl fra serveren.');
                }
            } catch (error) {
                console.error('Fejl ved afsendelse:', error);
                showStatusMessage(`Fejl: ${error.message}. Tjek konsollen.`, 'error', googleSheetStatus);
            } finally {
                sendToGoogleSheetsBtn.disabled = false;
                sendToGoogleSheetsBtn.textContent = "Send til Google Sheets";
            }
        }
        
        function openCsvExportModal() { /* As before... */ }
        function closeCsvExportModal() { /* As before... */ }
        function processAndExportCSV() { /* As before... */ }

        // --- Event Listeners ---
        openSettingsModalBtn.addEventListener('click', openSettingsModal);
        closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
        settingsForm.addEventListener('submit', saveSettings);
        timeRegistrationForm.addEventListener('submit', handleFormSubmit);
        cancelEditBtn.addEventListener('click', resetFormAndEditingState);
        sendToGoogleSheetsBtn.addEventListener('click', sendDataToGoogleSheets);
        exportCsvBtnModal.addEventListener('click', openCsvExportModal);
        confirmCsvExportBtn.addEventListener('click', processAndExportCSV);
        cancelCsvExportBtn.addEventListener('click', closeCsvExportModal);
        closeCsvExportModalBtn.addEventListener('click', closeCsvExportModal);
        registerSickBtn.addEventListener('click', () => registerAbsence('sick'));
        closeFreeDayTypeModalBtn.addEventListener('click', closeFreeDayTypeModal);
        registerFreeBtn.addEventListener('click', openFreeDayTypeModal);
        registerFerieHeleDageBtn.addEventListener('click', () => registerAbsence('ferie-hele-dage'));
        registerFriTimerBtn.addEventListener('click', () => {
            const hours = friTimerInput.value;
            registerAbsence('fri-timer', hours);
        });
        byggepladsSelect.addEventListener('change', (event) => {
            if (event.target.value === "ADD_NEW_SITE") { handleAddNewSite(); }
            else { updatePlaceringOptions(); lastSelectedPlacering = ''; placeringSelect.value = ''; }
        });
        placeringSelect.addEventListener('change', (event) => {
            if (event.target.value === "ADD_NEW_PLACERING") { handleAddNewPlacering(); }
        });
        datoInput.addEventListener('change', () => populateTimeDropdowns(datoInput.value));
        startTidSelect.addEventListener('change', filterSlutTidOptions);
    </script>
</body>
</html>
